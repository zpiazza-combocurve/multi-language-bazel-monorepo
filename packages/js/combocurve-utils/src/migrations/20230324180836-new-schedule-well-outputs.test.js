// eslint-disable-next-line @typescript-eslint/no-var-requires -- TODO eslint fix later
const { ObjectId } = require('bson');
// eslint-disable-next-line @typescript-eslint/no-var-requires -- TODO eslint fix later
const setupDb = require('../../tests/setup-db');
// eslint-disable-next-line @typescript-eslint/no-var-requires -- TODO eslint fix later
const { up, down } = require('./20230324180836-new-schedule-well-outputs');

let db;
let mongod;
let client;

let scheduleWellOutputs;

const oldScheduleWellOutputs = [
	{
		_id: new ObjectId('63a3437d6f86ee8162228c69'),
		output: {
			_id: '63750838f52f9500123c9b7e',
			preparationMobStart: 44918,
			preparationMobEnd: 44918,
			preparationWorkStart: 44919,
			preparationWorkEnd: 44923,
			preparationDemobStart: 44924,
			preparationDemobEnd: 44924,
			spudMobStart: null,
			spudMobEnd: null,
			spudWorkStart: null,
			spudWorkEnd: null,
			spudDemobStart: null,
			spudDemobEnd: null,
			drillResourceId: '639b335ea003e950f88d3e29',
			drillResourceName: 'Primary Rig 1',
			drillMobStart: 45028,
			drillMobEnd: 45028,
			drillWorkStart: 45029,
			drillWorkEnd: 45043,
			drillDemobStart: 45044,
			drillDemobEnd: 45045,
			completeResourceId: '639b335ea003e950f88d3e2c',
			completeResourceName: 'Completion Crew 1',
			completeMobStart: 45090,
			completeMobEnd: 45090,
			completeWorkStart: 45091,
			completeWorkEnd: 45105,
			completeDemobStart: 45106,
			completeDemobEnd: 45106,
			FPD: 45151,
		},
		project: new ObjectId('63487ee1dc31630012b224a0'),
		schedule: new ObjectId('63a3438def6ee60012751170'),
		construction: new ObjectId('63a3437d65edbaecbaeafe68'),
		well: new ObjectId('63750838f52f9500123c9b7e'),
	},
	{
		_id: new ObjectId('63a3437d6f86ee8162228c80'),
		output: {
			_id: '63750838f52f9500123c9b7e',
			preparationMobStart: 44918,
			preparationMobEnd: 44918,
			preparationWorkStart: 44919,
			preparationWorkEnd: 44923,
			preparationDemobStart: 44924,
			preparationDemobEnd: 44924,
			spudResourceId: '639b335ea003e950f88d3e33',
			spudResourceName: 'Spud Rig 1',
			spudMobStart: 44925,
			spudMobEnd: 44925,
			spudWorkStart: 44926,
			spudWorkEnd: 44926,
			spudDemobStart: 44927,
			spudDemobEnd: 44927,
			drillResourceId: '739b335ea003e950f88d3e33',
			drillResourceName: 'Primary Rig 1',
			drillMobStart: 45028,
			drillMobEnd: 45028,
			drillWorkStart: 45029,
			drillWorkEnd: 45043,
			drillDemobStart: 45044,
			drillDemobEnd: 45045,
			completeResourceId: '639b335ea003e950f88d3e2d',
			completeResourceName: 'Completion Crew 1',
			completeMobStart: null,
			completeMobEnd: null,
			completeWorkStart: 45091,
			completeWorkEnd: 45105,
			completeDemobStart: null,
			completeDemobEnd: null,
			FPD: 45151,
		},
		project: new ObjectId('63487ee1dc31630012b224a0'),
		schedule: new ObjectId('63a3438def6ee60012751171'),
		construction: new ObjectId('63a3437d65edbaecbaeafe69'),
		well: new ObjectId('63750838f52f9500123c9b7e'),
	},
	{
		_id: new ObjectId('63a3437d6f86ee8162228c81'),
		output: {
			_id: '63750838f52f9500123c9b7e',
			preparationMobStart: 44918,
			preparationMobEnd: 44918,
			preparationWorkStart: 44919,
			preparationWorkEnd: 44923,
			preparationDemobStart: 44924,
			preparationDemobEnd: 44924,
			spudResourceId: '639b335ea003e950f88d3e34',
			spudResourceName: 'Spud Rig 2',
			spudMobStart: 44925,
			spudMobEnd: 44925,
			spudWorkStart: 44926,
			spudWorkEnd: 44926,
			spudDemobStart: 44927,
			spudDemobEnd: 44927,
			drillResourceId: '739b335ea003e950f88d3e34',
			drillResourceName: 'Primary Rig 2',
			drillMobStart: 45028,
			drillMobEnd: 45028,
			drillWorkStart: 45029,
			drillWorkEnd: 45043,
			drillDemobStart: 45044,
			drillDemobEnd: 45045,
			completeResourceId: '639b335ea003e950f88d3e2f',
			completeResourceName: 'Completion Crew 2',
			completeMobStart: null,
			completeMobEnd: null,
			completeWorkStart: 45091,
			completeWorkEnd: 45105,
			completeDemobStart: null,
			completeDemobEnd: null,
			FPD: 45151,
		},
		project: new ObjectId('63487ee1dc31630012b224a0'),
		schedule: new ObjectId('63a3438def6ee60012751171'),
		construction: new ObjectId('63a3437d65edbaecbaeafe69'),
		well: new ObjectId('63750838f52f9500123c9b7f'),
	},
];

const newScheduleWellOutputs = [
	{
		_id: new ObjectId('63a3437d6f86ee8162228c69'),
		output: {
			events: [
				{
					activityStepIdx: 0,
					activityStepName: 'Pad Preparation',
					resourceIdx: null,
					resourceName: null,
					mob: { start: 44918, end: 44918 },
					work: { start: 44919, end: 44923 },
					demob: { start: 44924, end: 44924 },
				},
				{
					activityStepIdx: 1,
					activityStepName: 'Spud',
					resourceIdx: null,
					resourceName: null,
					mob: { start: null, end: null },
					work: { start: null, end: null },
					demob: { start: null, end: null },
				},
				{
					activityStepIdx: 2,
					activityStepName: 'Drill',
					resourceIdx: 0,
					resourceName: 'Primary Rig 1',
					mob: { start: 45028, end: 45028 },
					work: { start: 45029, end: 45043 },
					demob: { start: 45044, end: 45045 },
				},
				{
					activityStepIdx: 3,
					activityStepName: 'Completion',
					resourceIdx: 1,
					resourceName: 'Completion Crew 1',
					mob: { start: 45090, end: 45090 },
					work: { start: 45091, end: 45105 },
					demob: { start: 45106, end: 45106 },
				},
			],
			FPD: 45151,
		},
		project: new ObjectId('63487ee1dc31630012b224a0'),
		schedule: new ObjectId('63a3438def6ee60012751170'),
		construction: new ObjectId('63a3437d65edbaecbaeafe68'),
		well: new ObjectId('63750838f52f9500123c9b7e'),
	},
	{
		_id: new ObjectId('63a3437d6f86ee8162228c80'),
		output: {
			events: [
				{
					activityStepIdx: 0,
					activityStepName: 'Pad Preparation',
					resourceIdx: null,
					resourceName: null,
					mob: { start: 44918, end: 44918 },
					work: { start: 44919, end: 44923 },
					demob: { start: 44924, end: 44924 },
				},
				{
					activityStepIdx: 1,
					activityStepName: 'Spud',
					resourceIdx: 0,
					resourceName: 'Spud Rig 1',
					mob: { start: 44925, end: 44925 },
					work: { start: 44926, end: 44926 },
					demob: { start: 44927, end: 44927 },
				},
				{
					activityStepIdx: 2,
					activityStepName: 'Drill',
					resourceIdx: 1,
					resourceName: 'Primary Rig 1',
					mob: { start: 45028, end: 45028 },
					work: { start: 45029, end: 45043 },
					demob: { start: 45044, end: 45045 },
				},
				{
					activityStepIdx: 3,
					activityStepName: 'Completion',
					resourceIdx: 2,
					resourceName: 'Completion Crew 1',
					mob: { start: null, end: null },
					work: { start: 45091, end: 45105 },
					demob: { start: null, end: null },
				},
			],
			FPD: 45151,
		},
		project: new ObjectId('63487ee1dc31630012b224a0'),
		schedule: new ObjectId('63a3438def6ee60012751171'),
		construction: new ObjectId('63a3437d65edbaecbaeafe69'),
		well: new ObjectId('63750838f52f9500123c9b7e'),
	},
	{
		_id: new ObjectId('63a3437d6f86ee8162228c81'),
		output: {
			events: [
				{
					activityStepIdx: 0,
					activityStepName: 'Pad Preparation',
					resourceIdx: null,
					resourceName: null,
					mob: { start: 44918, end: 44918 },
					work: { start: 44919, end: 44923 },
					demob: { start: 44924, end: 44924 },
				},
				{
					activityStepIdx: 1,
					activityStepName: 'Spud',
					resourceIdx: 3,
					resourceName: 'Spud Rig 2',
					mob: { start: 44925, end: 44925 },
					work: { start: 44926, end: 44926 },
					demob: { start: 44927, end: 44927 },
				},
				{
					activityStepIdx: 2,
					activityStepName: 'Drill',
					resourceIdx: 4,
					resourceName: 'Primary Rig 2',
					mob: { start: 45028, end: 45028 },
					work: { start: 45029, end: 45043 },
					demob: { start: 45044, end: 45045 },
				},
				{
					activityStepIdx: 3,
					activityStepName: 'Completion',
					resourceIdx: 5,
					resourceName: 'Completion Crew 2',
					mob: { start: null, end: null },
					work: { start: 45091, end: 45105 },
					demob: { start: null, end: null },
				},
			],
			FPD: 45151,
		},
		project: new ObjectId('63487ee1dc31630012b224a0'),
		schedule: new ObjectId('63a3438def6ee60012751171'),
		construction: new ObjectId('63a3437d65edbaecbaeafe69'),
		well: new ObjectId('63750838f52f9500123c9b7f'),
	},
];

describe('new-schedule-config', () => {
	beforeEach(async () => {
		({ db, mongod, client } = await setupDb());

		scheduleWellOutputs = db.collection('schedule-well-outputs');
	});

	afterEach(async () => {
		await mongod.stop();
		await client.close();
	});

	test('up', async () => {
		await scheduleWellOutputs.insertMany(oldScheduleWellOutputs);

		await up({ db });
		await up({ db });

		const scheduleWellOutputsDocs = await scheduleWellOutputs.find({}).toArray();
		expect(scheduleWellOutputsDocs).toEqual(newScheduleWellOutputs);
	});

	test('down', async () => {
		await scheduleWellOutputs.insertMany(newScheduleWellOutputs);

		await down({ db });
		await down({ db });

		const scheduleWellOutputsDocs = await scheduleWellOutputs.find({}).toArray();
		expect(scheduleWellOutputsDocs).toEqual([
			{
				_id: new ObjectId('63a3437d6f86ee8162228c69'),
				output: {
					preparationMobStart: 44918,
					preparationMobEnd: 44918,
					preparationWorkStart: 44919,
					preparationWorkEnd: 44923,
					preparationDemobStart: 44924,
					preparationDemobEnd: 44924,
					spudMobStart: null,
					spudMobEnd: null,
					spudWorkStart: null,
					spudWorkEnd: null,
					spudDemobStart: null,
					spudDemobEnd: null,
					drillResourceId: 0,
					drillResourceName: 'Primary Rig 1',
					drillMobStart: 45028,
					drillMobEnd: 45028,
					drillWorkStart: 45029,
					drillWorkEnd: 45043,
					drillDemobStart: 45044,
					drillDemobEnd: 45045,
					completeResourceId: 1,
					completeResourceName: 'Completion Crew 1',
					completeMobStart: 45090,
					completeMobEnd: 45090,
					completeWorkStart: 45091,
					completeWorkEnd: 45105,
					completeDemobStart: 45106,
					completeDemobEnd: 45106,
					FPD: 45151,
				},
				project: new ObjectId('63487ee1dc31630012b224a0'),
				schedule: new ObjectId('63a3438def6ee60012751170'),
				construction: new ObjectId('63a3437d65edbaecbaeafe68'),
				well: new ObjectId('63750838f52f9500123c9b7e'),
			},
			{
				_id: new ObjectId('63a3437d6f86ee8162228c80'),
				output: {
					preparationMobStart: 44918,
					preparationMobEnd: 44918,
					preparationWorkStart: 44919,
					preparationWorkEnd: 44923,
					preparationDemobStart: 44924,
					preparationDemobEnd: 44924,
					spudResourceId: 0,
					spudResourceName: 'Spud Rig 1',
					spudMobStart: 44925,
					spudMobEnd: 44925,
					spudWorkStart: 44926,
					spudWorkEnd: 44926,
					spudDemobStart: 44927,
					spudDemobEnd: 44927,
					drillResourceId: 1,
					drillResourceName: 'Primary Rig 1',
					drillMobStart: 45028,
					drillMobEnd: 45028,
					drillWorkStart: 45029,
					drillWorkEnd: 45043,
					drillDemobStart: 45044,
					drillDemobEnd: 45045,
					completeResourceId: 2,
					completeResourceName: 'Completion Crew 1',
					completeMobStart: null,
					completeMobEnd: null,
					completeWorkStart: 45091,
					completeWorkEnd: 45105,
					completeDemobStart: null,
					completeDemobEnd: null,
					FPD: 45151,
				},
				project: new ObjectId('63487ee1dc31630012b224a0'),
				schedule: new ObjectId('63a3438def6ee60012751171'),
				construction: new ObjectId('63a3437d65edbaecbaeafe69'),
				well: new ObjectId('63750838f52f9500123c9b7e'),
			},
			{
				_id: new ObjectId('63a3437d6f86ee8162228c81'),
				output: {
					preparationMobStart: 44918,
					preparationMobEnd: 44918,
					preparationWorkStart: 44919,
					preparationWorkEnd: 44923,
					preparationDemobStart: 44924,
					preparationDemobEnd: 44924,
					spudResourceId: 3,
					spudResourceName: 'Spud Rig 2',
					spudMobStart: 44925,
					spudMobEnd: 44925,
					spudWorkStart: 44926,
					spudWorkEnd: 44926,
					spudDemobStart: 44927,
					spudDemobEnd: 44927,
					drillResourceId: 4,
					drillResourceName: 'Primary Rig 2',
					drillMobStart: 45028,
					drillMobEnd: 45028,
					drillWorkStart: 45029,
					drillWorkEnd: 45043,
					drillDemobStart: 45044,
					drillDemobEnd: 45045,
					completeResourceId: 5,
					completeResourceName: 'Completion Crew 2',
					completeMobStart: null,
					completeMobEnd: null,
					completeWorkStart: 45091,
					completeWorkEnd: 45105,
					completeDemobStart: null,
					completeDemobEnd: null,
					FPD: 45151,
				},
				project: new ObjectId('63487ee1dc31630012b224a0'),
				schedule: new ObjectId('63a3438def6ee60012751171'),
				construction: new ObjectId('63a3437d65edbaecbaeafe69'),
				well: new ObjectId('63750838f52f9500123c9b7f'),
			},
		]);
	});
});
