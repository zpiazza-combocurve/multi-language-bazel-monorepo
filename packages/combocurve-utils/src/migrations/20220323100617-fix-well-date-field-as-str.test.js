jest.setTimeout(30000);
// eslint-disable-next-line @typescript-eslint/no-var-requires -- TODO eslint fix later
const { ObjectId } = require('mongodb');

// eslint-disable-next-line @typescript-eslint/no-var-requires -- TODO eslint fix later
const setupDb = require('../../tests/setup-db');
// eslint-disable-next-line @typescript-eslint/no-var-requires -- TODO eslint fix later
const { up } = require('./20220323100617-fix-well-date-field-as-str');

let db;
let client;
let mongod;

const wellsBefore = [
	{ _id: new ObjectId('123456789012345678900001') },
	{
		_id: new ObjectId('123456789012345678900002'),
		first_prod_date: new Date('2000-01-01T00:00:00.000Z'),
		completion_end_date: new Date('2000-01-03T00:00:00.000Z'),
		completion_start_date: '2000-01-04T00:00:00.000Z',
		custom_date_0: '2001-01-01T00:00:00.000Z',
		custom_date_1: '2001-02-01T00:00:00.000Z',
		custom_date_2: '2001-01-01T00:00:00.000Z',
		custom_date_3: '2001-01-05T00:00:00.000Z',
		custom_date_4: new Date('2001-01-03T00:00:00.000Z'),
		custom_date_5: '2003-01-01T00:00:00.000Z',
		custom_date_6: '2001-04-01T00:00:00.000Z',
		custom_date_7: '2005-01-01T00:00:00.000Z',
		custom_date_8: '2001-08-01T00:00:00.000Z',
		custom_date_9: '2006-01-01T00:00:00.000Z',
		date_rig_release: new Date('2004-01-01T00:00:00.000Z'),
		drill_end_date: '2002-03-01T00:00:00.000Z',
		drill_start_date: '2002-01-25T00:00:00.000Z',
		gas_analysis_date: new Date('2002-01-20T00:00:00.000Z'),
		permit_date: '2012-01-01T00:00:00.000Z',
		refrac_date: new Date('2005-01-01T00:00:00.000Z'),
		spud_date: '2002-01-18T00:00:00.000Z',
		til: '2002-01-22T00:00:00.000Z',
		well_name: 'Custom Name',
	},
	{
		_id: new ObjectId('123456789012345678900003'),
		first_prod_date: new Date('2000-01-01'),
		completion_end_date: new Date('2000-05-03T00:00:00.000Z'),
		completion_start_date: '2015-01-04T00:00:00.000Z',
		custom_date_0: '2001-01-05T00:00:00.000Z',
		custom_date_6: null,
		custom_date_9: '2005-01-08T00:00:00.000Z',
		custom_date_8: '2001-08-21T00:00:00.000Z',
		custom_date_7: '2016-01-01T00:00:00.000Z',
		date_rig_release: null,
		drill_end_date: new Date('2012-03-01T00:00:00.000Z'),
		drill_start_date: '2002-03-25T00:00:00.000Z',
		gas_analysis_date: new Date('2002-05-20T00:00:00.000Z'),
		permit_date: '2011-01-01T00:00:00.000Z',
		refrac_date: new Date('2004-01-01T00:00:00.000Z'),
		spud_date: '2012-01-18T00:00:00.000Z',
		til: '2002-06-22T00:00:00.000Z',
		well_name: 'Custom Name 123',
	},
	{
		_id: new ObjectId('123456789012345678900004'),
		first_prod_date: new Date('2000-01-01T01:23:45.678Z'),
		completion_end_date: new Date('2001-01-03T00:00:00.000Z'),
		completion_start_date: new Date('2001-01-04T00:00:00.000Z'),
		custom_date_0: new Date('2009-01-01T00:00:00.000Z'),
		custom_date_1: new Date('2009-02-01T00:00:00.000Z'),
		custom_date_2: new Date('2009-01-01T00:00:00.000Z'),
		custom_date_3: new Date('2009-01-05T00:00:00.000Z'),
		custom_date_4: new Date('2009-01-03T00:00:00.000Z'),
		custom_date_5: new Date('2009-01-01T00:00:00.000Z'),
		custom_date_6: new Date('2009-04-01T00:00:00.000Z'),
		custom_date_7: new Date('2009-01-01T00:00:00.000Z'),
		custom_date_8: new Date('2009-08-01T00:00:00.000Z'),
		custom_date_9: new Date('2009-01-01T00:00:00.000Z'),
		date_rig_release: new Date('2004-08-01T00:00:00.000Z'),
		drill_end_date: new Date('2002-08-01T00:00:00.000Z'),
		drill_start_date: new Date('2002-08-25T00:00:00.000Z'),
		gas_analysis_date: new Date('2002-08-20T00:00:00.000Z'),
		permit_date: new Date('2012-08-01T00:00:00.000Z'),
		refrac_date: new Date('2005-08-01T00:00:00.000Z'),
		spud_date: new Date('2002-08-18T00:00:00.000Z'),
		til: new Date('2002-08-22T00:00:00.000Z'),
		well_name: 'Well Name 543',
	},
	{
		_id: new ObjectId('123456789012345678900005'),
		first_prod_date: '2001-01-01T00:00:00.000Z',
		completion_end_date: '2001-01-03T00:00:00.000Z',
		completion_start_date: '2001-01-04T00:00:00.000Z',
		custom_date_0: '2009-01-01T00:00:00.000Z',
		custom_date_1: '2009-02-01T00:00:00.000Z',
		custom_date_2: '2009-01-01T00:00:00.000Z',
		custom_date_3: '2009-01-05T00:00:00.000Z',
		custom_date_4: '2009-01-03T00:00:00.000Z',
		custom_date_5: '2009-01-01T00:00:00.000Z',
		custom_date_6: '2009-04-01T00:00:00.000Z',
		custom_date_7: '2009-01-01T00:00:00.000Z',
		custom_date_8: '2009-08-01T00:00:00.000Z',
		custom_date_9: '2009-01-01T00:00:00.000Z',
		date_rig_release: '2004-08-01T00:00:00.000Z',
		drill_end_date: '2002-08-01T00:00:00.000Z',
		drill_start_date: '2002-08-25T00:00:00.000Z',
		gas_analysis_date: '2002-08-20T00:00:00.000Z',
		permit_date: '2012-08-01T00:00:00.000Z',
		refrac_date: '2005-08-01T00:00:00.000Z',
		spud_date: '2002-08-18T00:00:00.000Z',
		til: '2002-08-22T00:00:00.000Z',
		well_name: 'Well Name',
	},
	{
		_id: new ObjectId('123456789012345678900006'),
		first_prod_date: '2000-01-01',
		completion_end_date: new Date('2000-01-03'),
		custom_date_0: '2001-01-01T00:00:00.000Z',
		custom_date_2: '2001-01-01T00:00:00.000Z',
		custom_date_3: '2001-01-05',
		custom_date_4: new Date('2001-01-03T00:00:00.000Z'),
		custom_date_7: '2005-01-01T00:00:00.000Z',
		custom_date_8: '2001-08-01',
		custom_date_9: new Date('2006-01-01T00:00:00.000Z'),
		date_rig_release: new Date('2004-01-01T00:00:00.000Z'),
		drill_end_date: '2002-03-01T00:00:00.000Z',
		drill_start_date: '2002-01-25',
		gas_analysis_date: new Date('2002-01-20T00:00:00.000Z'),
		permit_date: '2012-01-01T00:00:00.000Z',
		refrac_date: new Date('2005-01-01T00:00:00.000Z'),
		spud_date: new Date('2002-01-18'),
		til: '2002-01-22T00:00:00.000Z',
		well_name: 'Custom Name 99',
	},
	{
		_id: new ObjectId('123456789012345678900007'),
		first_prod_date: '2000-01-01T01:23:45.678Z',
		completion_end_date: '2000-01-03T00:00:00.000Z',
		completion_start_date: '2000-01-04T00:00:00.080Z',
		custom_date_0: '2003-01-01T00:00:00.000Z',
		custom_date_1: '2001-02-01T03:00:00.000Z',
		custom_date_2: new Date('2001-01-01T00:00:00.500Z'),
		custom_date_3: '2001-01-05T00:00:00.000Z',
		custom_date_4: new Date('2001-01-03T00:00:00.000Z'),
		custom_date_5: '2003-01-01T00:00:00.300Z',
		custom_date_6: null,
		custom_date_7: '2005-01-01T00:00:00.000Z',
		custom_date_8: '2001-08-01T04:00:00.000Z',
		custom_date_9: '2006-01-01T00:00:00.000Z',
		date_rig_release: new Date('2004-01-01T05:00:00.000Z'),
		drill_end_date: '2002-03-01T00:00:00.000Z',
		drill_start_date: '2002-01-25T00:00:00.000Z',
		gas_analysis_date: '2002-01-20T00:00:00.000Z',
		permit_date: new Date('2012-01-01T00:01:04.030Z'),
		refrac_date: null,
		spud_date: '2002-01-18T00:00:01.000Z',
		til: null,
		well_name: 'Last test name',
	},
];
const wellsAfter = [
	{ _id: new ObjectId('123456789012345678900001') },
	{
		_id: new ObjectId('123456789012345678900002'),
		first_prod_date: new Date('2000-01-01T00:00:00.000Z'),
		completion_end_date: new Date('2000-01-03T00:00:00.000Z'),
		completion_start_date: new Date('2000-01-04T00:00:00.000Z'),
		custom_date_0: new Date('2001-01-01T00:00:00.000Z'),
		custom_date_1: new Date('2001-02-01T00:00:00.000Z'),
		custom_date_2: new Date('2001-01-01T00:00:00.000Z'),
		custom_date_3: new Date('2001-01-05T00:00:00.000Z'),
		custom_date_4: new Date('2001-01-03T00:00:00.000Z'),
		custom_date_5: new Date('2003-01-01T00:00:00.000Z'),
		custom_date_6: new Date('2001-04-01T00:00:00.000Z'),
		custom_date_7: new Date('2005-01-01T00:00:00.000Z'),
		custom_date_8: new Date('2001-08-01T00:00:00.000Z'),
		custom_date_9: new Date('2006-01-01T00:00:00.000Z'),
		date_rig_release: new Date('2004-01-01T00:00:00.000Z'),
		drill_end_date: new Date('2002-03-01T00:00:00.000Z'),
		drill_start_date: new Date('2002-01-25T00:00:00.000Z'),
		gas_analysis_date: new Date('2002-01-20T00:00:00.000Z'),
		permit_date: new Date('2012-01-01T00:00:00.000Z'),
		refrac_date: new Date('2005-01-01T00:00:00.000Z'),
		spud_date: new Date('2002-01-18T00:00:00.000Z'),
		til: new Date('2002-01-22T00:00:00.000Z'),
		well_name: 'Custom Name',
	},
	{
		_id: new ObjectId('123456789012345678900003'),
		first_prod_date: new Date('2000-01-01'),
		completion_end_date: new Date('2000-05-03T00:00:00.000Z'),
		completion_start_date: new Date('2015-01-04T00:00:00.000Z'),
		custom_date_0: new Date('2001-01-05T00:00:00.000Z'),
		custom_date_6: null,
		custom_date_9: new Date('2005-01-08T00:00:00.000Z'),
		custom_date_8: new Date('2001-08-21T00:00:00.000Z'),
		custom_date_7: new Date('2016-01-01T00:00:00.000Z'),
		date_rig_release: null,
		drill_end_date: new Date('2012-03-01T00:00:00.000Z'),
		drill_start_date: new Date('2002-03-25T00:00:00.000Z'),
		gas_analysis_date: new Date('2002-05-20T00:00:00.000Z'),
		permit_date: new Date('2011-01-01T00:00:00.000Z'),
		refrac_date: new Date('2004-01-01T00:00:00.000Z'),
		spud_date: new Date('2012-01-18T00:00:00.000Z'),
		til: new Date('2002-06-22T00:00:00.000Z'),
		well_name: 'Custom Name 123',
	},
	{
		_id: new ObjectId('123456789012345678900004'),
		first_prod_date: new Date('2000-01-01T01:23:45.678Z'),
		completion_end_date: new Date('2001-01-03T00:00:00.000Z'),
		completion_start_date: new Date('2001-01-04T00:00:00.000Z'),
		custom_date_0: new Date('2009-01-01T00:00:00.000Z'),
		custom_date_1: new Date('2009-02-01T00:00:00.000Z'),
		custom_date_2: new Date('2009-01-01T00:00:00.000Z'),
		custom_date_3: new Date('2009-01-05T00:00:00.000Z'),
		custom_date_4: new Date('2009-01-03T00:00:00.000Z'),
		custom_date_5: new Date('2009-01-01T00:00:00.000Z'),
		custom_date_6: new Date('2009-04-01T00:00:00.000Z'),
		custom_date_7: new Date('2009-01-01T00:00:00.000Z'),
		custom_date_8: new Date('2009-08-01T00:00:00.000Z'),
		custom_date_9: new Date('2009-01-01T00:00:00.000Z'),
		date_rig_release: new Date('2004-08-01T00:00:00.000Z'),
		drill_end_date: new Date('2002-08-01T00:00:00.000Z'),
		drill_start_date: new Date('2002-08-25T00:00:00.000Z'),
		gas_analysis_date: new Date('2002-08-20T00:00:00.000Z'),
		permit_date: new Date('2012-08-01T00:00:00.000Z'),
		refrac_date: new Date('2005-08-01T00:00:00.000Z'),
		spud_date: new Date('2002-08-18T00:00:00.000Z'),
		til: new Date('2002-08-22T00:00:00.000Z'),
		well_name: 'Well Name 543',
	},
	{
		_id: new ObjectId('123456789012345678900005'),
		first_prod_date: new Date('2001-01-01T00:00:00.000Z'),
		completion_end_date: new Date('2001-01-03T00:00:00.000Z'),
		completion_start_date: new Date('2001-01-04T00:00:00.000Z'),
		custom_date_0: new Date('2009-01-01T00:00:00.000Z'),
		custom_date_1: new Date('2009-02-01T00:00:00.000Z'),
		custom_date_2: new Date('2009-01-01T00:00:00.000Z'),
		custom_date_3: new Date('2009-01-05T00:00:00.000Z'),
		custom_date_4: new Date('2009-01-03T00:00:00.000Z'),
		custom_date_5: new Date('2009-01-01T00:00:00.000Z'),
		custom_date_6: new Date('2009-04-01T00:00:00.000Z'),
		custom_date_7: new Date('2009-01-01T00:00:00.000Z'),
		custom_date_8: new Date('2009-08-01T00:00:00.000Z'),
		custom_date_9: new Date('2009-01-01T00:00:00.000Z'),
		date_rig_release: new Date('2004-08-01T00:00:00.000Z'),
		drill_end_date: new Date('2002-08-01T00:00:00.000Z'),
		drill_start_date: new Date('2002-08-25T00:00:00.000Z'),
		gas_analysis_date: new Date('2002-08-20T00:00:00.000Z'),
		permit_date: new Date('2012-08-01T00:00:00.000Z'),
		refrac_date: new Date('2005-08-01T00:00:00.000Z'),
		spud_date: new Date('2002-08-18T00:00:00.000Z'),
		til: new Date('2002-08-22T00:00:00.000Z'),
		well_name: 'Well Name',
	},
	{
		_id: new ObjectId('123456789012345678900006'),
		first_prod_date: new Date('2000-01-01'),
		completion_end_date: new Date('2000-01-03'),
		custom_date_0: new Date('2001-01-01T00:00:00.000Z'),
		custom_date_2: new Date('2001-01-01T00:00:00.000Z'),
		custom_date_3: new Date('2001-01-05'),
		custom_date_4: new Date('2001-01-03T00:00:00.000Z'),
		custom_date_7: new Date('2005-01-01T00:00:00.000Z'),
		custom_date_8: new Date('2001-08-01'),
		custom_date_9: new Date('2006-01-01T00:00:00.000Z'),
		date_rig_release: new Date('2004-01-01T00:00:00.000Z'),
		drill_end_date: new Date('2002-03-01T00:00:00.000Z'),
		drill_start_date: new Date('2002-01-25'),
		gas_analysis_date: new Date('2002-01-20T00:00:00.000Z'),
		permit_date: new Date('2012-01-01T00:00:00.000Z'),
		refrac_date: new Date('2005-01-01T00:00:00.000Z'),
		spud_date: new Date('2002-01-18'),
		til: new Date('2002-01-22T00:00:00.000Z'),
		well_name: 'Custom Name 99',
	},
	{
		_id: new ObjectId('123456789012345678900007'),
		first_prod_date: new Date('2000-01-01T01:23:45.678Z'),
		completion_end_date: new Date('2000-01-03T00:00:00.000Z'),
		completion_start_date: new Date('2000-01-04T00:00:00.080Z'),
		custom_date_0: new Date('2003-01-01T00:00:00.000Z'),
		custom_date_1: new Date('2001-02-01T03:00:00.000Z'),
		custom_date_2: new Date('2001-01-01T00:00:00.500Z'),
		custom_date_3: new Date('2001-01-05T00:00:00.000Z'),
		custom_date_4: new Date('2001-01-03T00:00:00.000Z'),
		custom_date_5: new Date('2003-01-01T00:00:00.300Z'),
		custom_date_6: null,
		custom_date_7: new Date('2005-01-01T00:00:00.000Z'),
		custom_date_8: new Date('2001-08-01T04:00:00.000Z'),
		custom_date_9: new Date('2006-01-01T00:00:00.000Z'),
		date_rig_release: new Date('2004-01-01T05:00:00.000Z'),
		drill_end_date: new Date('2002-03-01T00:00:00.000Z'),
		drill_start_date: new Date('2002-01-25T00:00:00.000Z'),
		gas_analysis_date: new Date('2002-01-20T00:00:00.000Z'),
		permit_date: new Date('2012-01-01T00:01:04.030Z'),
		refrac_date: null,
		spud_date: new Date('2002-01-18T00:00:01.000Z'),
		til: null,
		well_name: 'Last test name',
	},
];

beforeAll(async () => {
	({ db, client, mongod } = await setupDb());
});

afterAll(async () => {
	await mongod.stop();
	await client.close();
});

describe('20220323100617-fix-first-prod-date', () => {
	let wellsCollection;

	beforeAll(async () => {
		wellsCollection = db.collection('wells');
		await wellsCollection.insertMany(wellsBefore);
	});

	test('up', async () => {
		await up({ db });

		const result = await wellsCollection.find({}).sort({ _id: 1 }).toArray();

		expect(result).toEqual(wellsAfter);
	});

	test('idempotency', async () => {
		await up({ db });
		await up({ db });

		const result = await wellsCollection.find({}).sort({ _id: 1 }).toArray();

		expect(result).toEqual(wellsAfter);
	});
});
