import pytest
import numpy as np
import pandas as pd
from math import isclose
from datetime import datetime
import json
import mongomock
import os
from bson import ObjectId
from combocurve.services.type_curve.tc_apply_service import _get_segments_list, TypeCurveApplyService
from combocurve.services.type_curve.tc_normalization_data_models import (BaseDocument, StepsDocument, StepsItem,
                                                                         OpChainDocument)
from combocurve.services.forecast.deterministic_forecast_service import DeterministicForecastService


def _create_db():
    collections = {}
    file_dir = os.path.dirname(os.path.realpath('__file__'))

    wells_collection = mongomock.MongoClient().db.collection
    data_path = os.path.join(file_dir, 'combocurve/services/forecast/db_test_data/wells.json')

    with open(data_path, 'r') as f:
        prod_data = json.load(f)
    for doc in prod_data:
        doc['_id'] = ObjectId(doc['_id'])
        for key in ['first_prod_date_monthly_calc', 'first_prod_date_daily_calc', 'first_prod_date']:
            if not doc[key]:
                continue
            try:
                doc[key] = datetime.strptime(doc[key], '%Y-%m-%d %H:%M:%S')
            except Exception:
                doc[key] = datetime.strptime(doc[key], '%Y-%m-%d %H:%M:%S.%f')
        wells_collection.insert_one(doc)
    collections['wells'] = wells_collection

    return collections


class MockContext():
    def __init__(self):
        collections = _create_db()
        db = {}
        self.wells_collection = db['wells'] = collections['wells']
        self.db = db
        self.deterministic_forecast_service = DeterministicForecastService(self)


'''
Apply 2-factor norm test cases:
1. Modified Arps
2. Arps
3. Flat
4. Shut-in
5. Exp ratio tc rate phase
6. Linear ratio tc ratio phase
7. Linear decline
'''
test_segments_inputs_two_factor = [
    ({
        'segments': [{
            'D': 0.007439574642451289,
            'D_eff': 0.6057797675906641,
            'b': 2,
            'end_idx': 3837,
            'name': 'arps',
            'q_end': 31.731821618291967,
            'q_start': 241.85247509590954,
            'slope': -1,
            'start_idx': 0
        }, {
            'D': 0.0001280415217852087,
            'D_eff': 0.04438537066214765,
            'D_exp': 0.0001280415217852087,
            'D_exp_eff': 0.045690432400876,
            'b': 1.3000676824714958,
            'end_idx': 21914,
            'name': 'arps_modified',
            'q_end': 3.1125947272809817,
            'q_start': 31.498352522313887,
            'q_sw': 31.498352522313887,
            'realized_D_eff_sw': 0.045690432400876,
            'slope': -1,
            'start_idx': 3838,
            'sw_idx': 3838,
            'target_D_eff_sw': 0.08
        }],
        'delta_index':
        np.array([44867]),
        'multipliers': {
            'eur': np.array([1.]),
            'qPeak': np.array([1.])
        },
        'steps':
        StepsDocument(eur=StepsItem(key='normalize',
                                    base=BaseDocument(key='eur_pll',
                                                      x=OpChainDocument(startFeature='perf_lateral_length', opChain=[]),
                                                      y=OpChainDocument(startFeature='eur', opChain=[])),
                                    name='Normalize',
                                    type='1_to_1',
                                    rangeStart=0.02,
                                    rangeEnd=0.98,
                                    diverged=False,
                                    multiplier=1.0,
                                    target={
                                        'acre_spacing': 100,
                                        'azimuth': 100,
                                        'before_income_tax_cash_flow': 14547.78,
                                        'casing_id': 100,
                                        'choke_size': 100,
                                        'cum_boe': 140.55,
                                        'cum_boe_per_perforated_interval': 30.2,
                                        'cum_gas': 281.4,
                                        'cum_gas_per_perforated_interval': 61.42,
                                        'cum_gor': 2577.96,
                                        'cum_mmcfge': 843.32,
                                        'cum_mmcfge_per_perforated_interval': 181.18,
                                        'cum_oil': 93.65,
                                        'cum_oil_per_perforated_interval': 19.96,
                                        'cum_water': 84.4,
                                        'cum_water_per_perforated_interval': 18.47,
                                        'custom_number_0': 100,
                                        'custom_number_1': 100,
                                        'custom_number_10': 100,
                                        'custom_number_11': 100,
                                        'custom_number_12': 100,
                                        'custom_number_13': 100,
                                        'custom_number_14': 100,
                                        'custom_number_15': 100,
                                        'custom_number_16': 100,
                                        'custom_number_17': 100,
                                        'custom_number_18': 100,
                                        'custom_number_19': 100,
                                        'custom_number_2': 100,
                                        'custom_number_3': 100,
                                        'custom_number_4': 100,
                                        'custom_number_5': 100,
                                        'custom_number_6': 100,
                                        'custom_number_7': 100,
                                        'custom_number_8': 100,
                                        'custom_number_9': 100,
                                        'distance_from_base_of_zone': 100,
                                        'distance_from_top_of_zone': 100,
                                        'elevation': 5483.2,
                                        'first_12_boe': 65.15,
                                        'first_12_boe_per_perforated_interval': 13.96,
                                        'first_12_gas': 97.03,
                                        'first_12_gas_per_perforated_interval': 21.07,
                                        'first_12_gor': 1739.13,
                                        'first_12_mmcfge': 390.89,
                                        'first_12_mmcfge_per_perforated_interval': 83.73,
                                        'first_12_oil': 48.98,
                                        'first_12_oil_per_perforated_interval': 10.44,
                                        'first_12_water': 39.29,
                                        'first_12_water_per_perforated_interval': 8.63,
                                        'first_6_boe': 35.53,
                                        'first_6_boe_per_perforated_interval': 7.74,
                                        'first_6_gas': 47.79,
                                        'first_6_gas_per_perforated_interval': 10.68,
                                        'first_6_gor': 1520.05,
                                        'first_6_mmcfge': 213.17,
                                        'first_6_mmcfge_per_perforated_interval': 46.44,
                                        'first_6_oil': 27.56,
                                        'first_6_oil_per_perforated_interval': 5.96,
                                        'first_6_water': 22.83,
                                        'first_6_water_per_perforated_interval': 5.06,
                                        'first_additive_volume': 100,
                                        'first_cluster_count': 100,
                                        'first_discount_cash_flow': 1944.38,
                                        'first_fluid_per_perforated_interval': 100,
                                        'first_fluid_volume': 100,
                                        'first_max_injection_pressure': 100,
                                        'first_max_injection_rate': 100,
                                        'first_prop_weight': 100,
                                        'first_proppant_per_fluid': 100,
                                        'first_proppant_per_perforated_interval': 100,
                                        'first_stage_count': 100,
                                        'first_test_flow_tbg_press': 100,
                                        'first_test_gas_vol': 100,
                                        'first_test_gor': 100,
                                        'first_test_oil_vol': 100,
                                        'first_test_water_vol': 100,
                                        'footage_in_landing_zone': 100,
                                        'formation_thickness_mean': 100,
                                        'gas_breakeven': 100,
                                        'gas_shrunk_eur': 100,
                                        'gas_shrunk_eur_over_pll': 100,
                                        'gas_specific_gravity': 100,
                                        'ground_elevation': 5461.81,
                                        'heelLatitude': 100,
                                        'heelLongitude': 100,
                                        'hz_well_spacing_any_zone': 100,
                                        'hz_well_spacing_same_zone': 100,
                                        'initial_respress': 100,
                                        'initial_restemp': 100,
                                        'irr': 580.55,
                                        'landing_zone_base': 100,
                                        'landing_zone_top': 100,
                                        'last_12_boe': 12.44,
                                        'last_12_boe_per_perforated_interval': 2.53,
                                        'last_12_gas': 34.17,
                                        'last_12_gas_per_perforated_interval': 6.9,
                                        'last_12_gor': 4855.07,
                                        'last_12_mmcfge': 74.61,
                                        'last_12_mmcfge_per_perforated_interval': 15.17,
                                        'last_12_oil': 6.74,
                                        'last_12_oil_per_perforated_interval': 1.38,
                                        'last_12_water': 5.82,
                                        'last_12_water_per_perforated_interval': 1.27,
                                        'last_month_boe': 0.98,
                                        'last_month_boe_per_perforated_interval': 0.2,
                                        'last_month_gas': 2.7,
                                        'last_month_gas_per_perforated_interval': 0.54,
                                        'last_month_gor': 4979.31,
                                        'last_month_mmcfge': 5.88,
                                        'last_month_mmcfge_per_perforated_interval': 1.2,
                                        'last_month_oil': 0.53,
                                        'last_month_oil_per_perforated_interval': 0.11,
                                        'last_month_water': 0.49,
                                        'last_month_water_per_perforated_interval': 0.11,
                                        'lateral_length': 4682,
                                        'lower_perforation': 12882.4,
                                        'matrix_permeability': 100,
                                        'measured_depth': 12925.2,
                                        'month_produced': 62.6,
                                        'ngl_shrunk_eur': 100,
                                        'ngl_shrunk_eur_over_pll': 100,
                                        'nri_oil': 100,
                                        'num_treatment_records': 0.4,
                                        'oil_api_gravity': 100,
                                        'oil_breakeven': 100,
                                        'oil_shrunk_eur': 100,
                                        'oil_shrunk_eur_over_pll': 100,
                                        'oil_specific_gravity': 40.44,
                                        'payout_duration': 18.4,
                                        'perf_lateral_length': 4580.4,
                                        'refrac_additive_volume': 100,
                                        'refrac_cluster_count': 100,
                                        'refrac_fluid_per_perforated_interval': 100,
                                        'refrac_fluid_volume': 100,
                                        'refrac_max_injection_pressure': 100,
                                        'refrac_max_injection_rate': 100,
                                        'refrac_prop_weight': 100,
                                        'refrac_proppant_per_fluid': 100,
                                        'refrac_proppant_per_perforated_interval': 100,
                                        'refrac_stage_count': 100,
                                        'stage_spacing': 100,
                                        'surfaceLatitude': 40.92,
                                        'surfaceLongitude': -104.61,
                                        'thickness': 100,
                                        'toeLatitude': 40.92,
                                        'toeLongitude': -104.62,
                                        'total_additive_volume': 100,
                                        'total_cluster_count': 100,
                                        'total_fluid_per_perforated_interval': 100,
                                        'total_fluid_volume': 0,
                                        'total_prop_weight': 0,
                                        'total_proppant_per_fluid': 100,
                                        'total_proppant_per_perforated_interval': 100,
                                        'total_stage_count': 100,
                                        'true_vertical_depth': 7970.4,
                                        'tubing_depth': 100,
                                        'tubing_id': 100,
                                        'undiscounted_roi': 100,
                                        'upper_perforation': 8302,
                                        'vt_well_spacing_any_zone': 100,
                                        'vt_well_spacing_same_zone': 100,
                                        'wi_oil': 100,
                                        'first_prop_weight/perf_lateral_length': 0.021832154396995897,
                                        'first_fluid_volume/perf_lateral_length': 0.021832154396995897,
                                        'first_prop_weight/perf_lateral_length/hz_well_spacing_same_zone':
                                        0.00021832154396995897,
                                        'first_fluid_volume/perf_lateral_length/hz_well_spacing_same_zone':
                                        0.00021832154396995897,
                                        'first_prop_weight/acre_spacing': 1,
                                        'first_fluid_volume/acre_spacing': 1,
                                        'eur': 437112.5010883607
                                    },
                                    normalizationMin=0.0,
                                    normalizationMax=0.0,
                                    aValue=147.39255237339438,
                                    bValue=-219877.55389907834),
                      qPeak=StepsItem(key='normalize',
                                      base=BaseDocument(key='peak_pll',
                                                        x=OpChainDocument(startFeature='perf_lateral_length',
                                                                          opChain=[]),
                                                        y=OpChainDocument(startFeature='peak_rate', opChain=[])),
                                      name='Normalize',
                                      type='linear',
                                      rangeStart=0.02,
                                      rangeEnd=0.98,
                                      diverged=False,
                                      multiplier=1.0,
                                      target={
                                          'acre_spacing': 100,
                                          'azimuth': 100,
                                          'before_income_tax_cash_flow': 14547.78,
                                          'casing_id': 100,
                                          'choke_size': 100,
                                          'cum_boe': 140.55,
                                          'cum_boe_per_perforated_interval': 30.2,
                                          'cum_gas': 281.4,
                                          'cum_gas_per_perforated_interval': 61.42,
                                          'cum_gor': 2577.96,
                                          'cum_mmcfge': 843.32,
                                          'cum_mmcfge_per_perforated_interval': 181.18,
                                          'cum_oil': 93.65,
                                          'cum_oil_per_perforated_interval': 19.96,
                                          'cum_water': 84.4,
                                          'cum_water_per_perforated_interval': 18.47,
                                          'custom_number_0': 100,
                                          'custom_number_1': 100,
                                          'custom_number_10': 100,
                                          'custom_number_11': 100,
                                          'custom_number_12': 100,
                                          'custom_number_13': 100,
                                          'custom_number_14': 100,
                                          'custom_number_15': 100,
                                          'custom_number_16': 100,
                                          'custom_number_17': 100,
                                          'custom_number_18': 100,
                                          'custom_number_19': 100,
                                          'custom_number_2': 100,
                                          'custom_number_3': 100,
                                          'custom_number_4': 100,
                                          'custom_number_5': 100,
                                          'custom_number_6': 100,
                                          'custom_number_7': 100,
                                          'custom_number_8': 100,
                                          'custom_number_9': 100,
                                          'distance_from_base_of_zone': 100,
                                          'distance_from_top_of_zone': 100,
                                          'elevation': 5483.2,
                                          'first_12_boe': 65.15,
                                          'first_12_boe_per_perforated_interval': 13.96,
                                          'first_12_gas': 97.03,
                                          'first_12_gas_per_perforated_interval': 21.07,
                                          'first_12_gor': 1739.13,
                                          'first_12_mmcfge': 390.89,
                                          'first_12_mmcfge_per_perforated_interval': 83.73,
                                          'first_12_oil': 48.98,
                                          'first_12_oil_per_perforated_interval': 10.44,
                                          'first_12_water': 39.29,
                                          'first_12_water_per_perforated_interval': 8.63,
                                          'first_6_boe': 35.53,
                                          'first_6_boe_per_perforated_interval': 7.74,
                                          'first_6_gas': 47.79,
                                          'first_6_gas_per_perforated_interval': 10.68,
                                          'first_6_gor': 1520.05,
                                          'first_6_mmcfge': 213.17,
                                          'first_6_mmcfge_per_perforated_interval': 46.44,
                                          'first_6_oil': 27.56,
                                          'first_6_oil_per_perforated_interval': 5.96,
                                          'first_6_water': 22.83,
                                          'first_6_water_per_perforated_interval': 5.06,
                                          'first_additive_volume': 100,
                                          'first_cluster_count': 100,
                                          'first_discount_cash_flow': 1944.38,
                                          'first_fluid_per_perforated_interval': 100,
                                          'first_fluid_volume': 100,
                                          'first_max_injection_pressure': 100,
                                          'first_max_injection_rate': 100,
                                          'first_prop_weight': 100,
                                          'first_proppant_per_fluid': 100,
                                          'first_proppant_per_perforated_interval': 100,
                                          'first_stage_count': 100,
                                          'first_test_flow_tbg_press': 100,
                                          'first_test_gas_vol': 100,
                                          'first_test_gor': 100,
                                          'first_test_oil_vol': 100,
                                          'first_test_water_vol': 100,
                                          'footage_in_landing_zone': 100,
                                          'formation_thickness_mean': 100,
                                          'gas_breakeven': 100,
                                          'gas_shrunk_eur': 100,
                                          'gas_shrunk_eur_over_pll': 100,
                                          'gas_specific_gravity': 100,
                                          'ground_elevation': 5461.81,
                                          'heelLatitude': 100,
                                          'heelLongitude': 100,
                                          'hz_well_spacing_any_zone': 100,
                                          'hz_well_spacing_same_zone': 100,
                                          'initial_respress': 100,
                                          'initial_restemp': 100,
                                          'irr': 580.55,
                                          'landing_zone_base': 100,
                                          'landing_zone_top': 100,
                                          'last_12_boe': 12.44,
                                          'last_12_boe_per_perforated_interval': 2.53,
                                          'last_12_gas': 34.17,
                                          'last_12_gas_per_perforated_interval': 6.9,
                                          'last_12_gor': 4855.07,
                                          'last_12_mmcfge': 74.61,
                                          'last_12_mmcfge_per_perforated_interval': 15.17,
                                          'last_12_oil': 6.74,
                                          'last_12_oil_per_perforated_interval': 1.38,
                                          'last_12_water': 5.82,
                                          'last_12_water_per_perforated_interval': 1.27,
                                          'last_month_boe': 0.98,
                                          'last_month_boe_per_perforated_interval': 0.2,
                                          'last_month_gas': 2.7,
                                          'last_month_gas_per_perforated_interval': 0.54,
                                          'last_month_gor': 4979.31,
                                          'last_month_mmcfge': 5.88,
                                          'last_month_mmcfge_per_perforated_interval': 1.2,
                                          'last_month_oil': 0.53,
                                          'last_month_oil_per_perforated_interval': 0.11,
                                          'last_month_water': 0.49,
                                          'last_month_water_per_perforated_interval': 0.11,
                                          'lateral_length': 4682,
                                          'lower_perforation': 12882.4,
                                          'matrix_permeability': 100,
                                          'measured_depth': 12925.2,
                                          'month_produced': 62.6,
                                          'ngl_shrunk_eur': 100,
                                          'ngl_shrunk_eur_over_pll': 100,
                                          'nri_oil': 100,
                                          'num_treatment_records': 0.4,
                                          'oil_api_gravity': 100,
                                          'oil_breakeven': 100,
                                          'oil_shrunk_eur': 100,
                                          'oil_shrunk_eur_over_pll': 100,
                                          'oil_specific_gravity': 40.44,
                                          'payout_duration': 18.4,
                                          'perf_lateral_length': 4580.4,
                                          'refrac_additive_volume': 100,
                                          'refrac_cluster_count': 100,
                                          'refrac_fluid_per_perforated_interval': 100,
                                          'refrac_fluid_volume': 100,
                                          'refrac_max_injection_pressure': 100,
                                          'refrac_max_injection_rate': 100,
                                          'refrac_prop_weight': 100,
                                          'refrac_proppant_per_fluid': 100,
                                          'refrac_proppant_per_perforated_interval': 100,
                                          'refrac_stage_count': 100,
                                          'stage_spacing': 100,
                                          'surfaceLatitude': 40.92,
                                          'surfaceLongitude': -104.61,
                                          'thickness': 100,
                                          'toeLatitude': 40.92,
                                          'toeLongitude': -104.62,
                                          'total_additive_volume': 100,
                                          'total_cluster_count': 100,
                                          'total_fluid_per_perforated_interval': 100,
                                          'total_fluid_volume': 0,
                                          'total_prop_weight': 0,
                                          'total_proppant_per_fluid': 100,
                                          'total_proppant_per_perforated_interval': 100,
                                          'total_stage_count': 100,
                                          'true_vertical_depth': 7970.4,
                                          'tubing_depth': 100,
                                          'tubing_id': 100,
                                          'undiscounted_roi': 100,
                                          'upper_perforation': 8302,
                                          'vt_well_spacing_any_zone': 100,
                                          'vt_well_spacing_same_zone': 100,
                                          'wi_oil': 100,
                                          'first_prop_weight/perf_lateral_length': 0.021832154396995897,
                                          'first_fluid_volume/perf_lateral_length': 0.021832154396995897,
                                          'first_prop_weight/perf_lateral_length/hz_well_spacing_same_zone':
                                          0.00021832154396995897,
                                          'first_fluid_volume/perf_lateral_length/hz_well_spacing_same_zone':
                                          0.00021832154396995897,
                                          'first_prop_weight/acre_spacing': 1,
                                          'first_fluid_volume/acre_spacing': 1,
                                          'peak_rate': 241.85247509590954
                                      },
                                      normalizationMin=0.0,
                                      normalizationMax=0.0,
                                      aValue=2.0861869844538434,
                                      bValue=-2197.770863592384),
                      normalizationType='eur_and_q_peak'),
        'target_eur':
        437112.5010883607,
        'target_q_peak':
        241.85247509590954,
        'apply_normalization':
        True
    }, [[{
        'D': 0.007439574642451289,
        'D_eff': 0.6057797675906641,
        'b': 2,
        'end_idx': 48704,
        'name': 'arps',
        'q_end': 31.731821618291967,
        'q_start': 241.85247509590954,
        'slope': -1,
        'start_idx': 44867
    }, {
        'D': 0.00012804146441518948,
        'D_eff': 0.044385351785524114,
        'D_exp': 0.00012804146441518948,
        'D_exp_eff': 0.045690412403891933,
        'b': 1.3000676824714958,
        'end_idx': 66781,
        'name': 'arps_modified',
        'q_end': 3.112597955107094,
        'q_start': 31.498352522313887,
        'q_sw': 31.498352522313887,
        'realized_D_eff_sw': 0.045690412403891933,
        'slope': -1,
        'start_idx': 48705,
        'sw_idx': 48705.0,
        'target_D_eff_sw': 0.08
    }]]),
    ({
        'segments': [{
            'start_idx': 1,
            'q_start': 400,
            'end_idx': 6109,
            'q_end': 50,
            'b': 0.9,
            'D': 0.0010000269878430348,
            'D_eff': 0.2708,
            'slope': -1,
            'name': 'arps'
        }],
        'delta_index':
        np.array([44866]),
        'multipliers': {
            'eur': np.array([1.]),
            'qPeak': np.array([1.])
        },
        'steps':
        StepsDocument(eur=StepsItem(key='normalize',
                                    base=BaseDocument(key='eur_pll',
                                                      x=OpChainDocument(startFeature='perf_lateral_length', opChain=[]),
                                                      y=OpChainDocument(startFeature='eur', opChain=[])),
                                    name='Normalize',
                                    type='1_to_1',
                                    rangeStart=0.02,
                                    rangeEnd=0.98,
                                    diverged=False,
                                    multiplier=1.0,
                                    target={
                                        'acre_spacing': 100,
                                        'azimuth': 100,
                                        'before_income_tax_cash_flow': 14547.78,
                                        'casing_id': 100,
                                        'choke_size': 100,
                                        'cum_boe': 140.55,
                                        'cum_boe_per_perforated_interval': 30.2,
                                        'cum_gas': 281.4,
                                        'cum_gas_per_perforated_interval': 61.42,
                                        'cum_gor': 2577.96,
                                        'cum_mmcfge': 843.32,
                                        'cum_mmcfge_per_perforated_interval': 181.18,
                                        'cum_oil': 93.65,
                                        'cum_oil_per_perforated_interval': 19.96,
                                        'cum_water': 84.4,
                                        'cum_water_per_perforated_interval': 18.47,
                                        'custom_number_0': 100,
                                        'custom_number_1': 100,
                                        'custom_number_10': 100,
                                        'custom_number_11': 100,
                                        'custom_number_12': 100,
                                        'custom_number_13': 100,
                                        'custom_number_14': 100,
                                        'custom_number_15': 100,
                                        'custom_number_16': 100,
                                        'custom_number_17': 100,
                                        'custom_number_18': 100,
                                        'custom_number_19': 100,
                                        'custom_number_2': 100,
                                        'custom_number_3': 100,
                                        'custom_number_4': 100,
                                        'custom_number_5': 100,
                                        'custom_number_6': 100,
                                        'custom_number_7': 100,
                                        'custom_number_8': 100,
                                        'custom_number_9': 100,
                                        'distance_from_base_of_zone': 100,
                                        'distance_from_top_of_zone': 100,
                                        'elevation': 5483.2,
                                        'first_12_boe': 65.15,
                                        'first_12_boe_per_perforated_interval': 13.96,
                                        'first_12_gas': 97.03,
                                        'first_12_gas_per_perforated_interval': 21.07,
                                        'first_12_gor': 1739.13,
                                        'first_12_mmcfge': 390.89,
                                        'first_12_mmcfge_per_perforated_interval': 83.73,
                                        'first_12_oil': 48.98,
                                        'first_12_oil_per_perforated_interval': 10.44,
                                        'first_12_water': 39.29,
                                        'first_12_water_per_perforated_interval': 8.63,
                                        'first_6_boe': 35.53,
                                        'first_6_boe_per_perforated_interval': 7.74,
                                        'first_6_gas': 47.79,
                                        'first_6_gas_per_perforated_interval': 10.68,
                                        'first_6_gor': 1520.05,
                                        'first_6_mmcfge': 213.17,
                                        'first_6_mmcfge_per_perforated_interval': 46.44,
                                        'first_6_oil': 27.56,
                                        'first_6_oil_per_perforated_interval': 5.96,
                                        'first_6_water': 22.83,
                                        'first_6_water_per_perforated_interval': 5.06,
                                        'first_additive_volume': 100,
                                        'first_cluster_count': 100,
                                        'first_discount_cash_flow': 1944.38,
                                        'first_fluid_per_perforated_interval': 100,
                                        'first_fluid_volume': 100,
                                        'first_max_injection_pressure': 100,
                                        'first_max_injection_rate': 100,
                                        'first_prop_weight': 100,
                                        'first_proppant_per_fluid': 100,
                                        'first_proppant_per_perforated_interval': 100,
                                        'first_stage_count': 100,
                                        'first_test_flow_tbg_press': 100,
                                        'first_test_gas_vol': 100,
                                        'first_test_gor': 100,
                                        'first_test_oil_vol': 100,
                                        'first_test_water_vol': 100,
                                        'footage_in_landing_zone': 100,
                                        'formation_thickness_mean': 100,
                                        'gas_breakeven': 100,
                                        'gas_shrunk_eur': 100,
                                        'gas_shrunk_eur_over_pll': 100,
                                        'gas_specific_gravity': 100,
                                        'ground_elevation': 5461.81,
                                        'heelLatitude': 100,
                                        'heelLongitude': 100,
                                        'hz_well_spacing_any_zone': 100,
                                        'hz_well_spacing_same_zone': 100,
                                        'initial_respress': 100,
                                        'initial_restemp': 100,
                                        'irr': 580.55,
                                        'landing_zone_base': 100,
                                        'landing_zone_top': 100,
                                        'last_12_boe': 12.44,
                                        'last_12_boe_per_perforated_interval': 2.53,
                                        'last_12_gas': 34.17,
                                        'last_12_gas_per_perforated_interval': 6.9,
                                        'last_12_gor': 4855.07,
                                        'last_12_mmcfge': 74.61,
                                        'last_12_mmcfge_per_perforated_interval': 15.17,
                                        'last_12_oil': 6.74,
                                        'last_12_oil_per_perforated_interval': 1.38,
                                        'last_12_water': 5.82,
                                        'last_12_water_per_perforated_interval': 1.27,
                                        'last_month_boe': 0.98,
                                        'last_month_boe_per_perforated_interval': 0.2,
                                        'last_month_gas': 2.7,
                                        'last_month_gas_per_perforated_interval': 0.54,
                                        'last_month_gor': 4979.31,
                                        'last_month_mmcfge': 5.88,
                                        'last_month_mmcfge_per_perforated_interval': 1.2,
                                        'last_month_oil': 0.53,
                                        'last_month_oil_per_perforated_interval': 0.11,
                                        'last_month_water': 0.49,
                                        'last_month_water_per_perforated_interval': 0.11,
                                        'lateral_length': 4682,
                                        'lower_perforation': 12882.4,
                                        'matrix_permeability': 100,
                                        'measured_depth': 12925.2,
                                        'month_produced': 62.6,
                                        'ngl_shrunk_eur': 100,
                                        'ngl_shrunk_eur_over_pll': 100,
                                        'nri_oil': 100,
                                        'num_treatment_records': 0.4,
                                        'oil_api_gravity': 100,
                                        'oil_breakeven': 100,
                                        'oil_shrunk_eur': 100,
                                        'oil_shrunk_eur_over_pll': 100,
                                        'oil_specific_gravity': 40.44,
                                        'payout_duration': 18.4,
                                        'perf_lateral_length': 9000,
                                        'refrac_additive_volume': 100,
                                        'refrac_cluster_count': 100,
                                        'refrac_fluid_per_perforated_interval': 100,
                                        'refrac_fluid_volume': 100,
                                        'refrac_max_injection_pressure': 100,
                                        'refrac_max_injection_rate': 100,
                                        'refrac_prop_weight': 100,
                                        'refrac_proppant_per_fluid': 100,
                                        'refrac_proppant_per_perforated_interval': 100,
                                        'refrac_stage_count': 100,
                                        'stage_spacing': 100,
                                        'surfaceLatitude': 40.92,
                                        'surfaceLongitude': -104.61,
                                        'thickness': 100,
                                        'toeLatitude': 40.92,
                                        'toeLongitude': -104.62,
                                        'total_additive_volume': 100,
                                        'total_cluster_count': 100,
                                        'total_fluid_per_perforated_interval': 100,
                                        'total_fluid_volume': 0,
                                        'total_prop_weight': 0,
                                        'total_proppant_per_fluid': 100,
                                        'total_proppant_per_perforated_interval': 100,
                                        'total_stage_count': 100,
                                        'true_vertical_depth': 7970.4,
                                        'tubing_depth': 100,
                                        'tubing_id': 100,
                                        'undiscounted_roi': 100,
                                        'upper_perforation': 8302,
                                        'vt_well_spacing_any_zone': 100,
                                        'vt_well_spacing_same_zone': 100,
                                        'wi_oil': 100,
                                        'first_prop_weight/perf_lateral_length': 0.021832154396995897,
                                        'first_fluid_volume/perf_lateral_length': 0.021832154396995897,
                                        'first_prop_weight/perf_lateral_length/hz_well_spacing_same_zone':
                                        0.00021832154396995897,
                                        'first_fluid_volume/perf_lateral_length/hz_well_spacing_same_zone':
                                        0.00021832154396995897,
                                        'first_prop_weight/acre_spacing': 1,
                                        'first_fluid_volume/acre_spacing': 1,
                                        'eur': 751157.9308657959
                                    },
                                    normalizationMin=0.0,
                                    normalizationMax=0.0,
                                    aValue=147.39255237339438,
                                    bValue=-219877.55389907834),
                      qPeak=StepsItem(key='normalize',
                                      base=BaseDocument(key='peak_pll',
                                                        x=OpChainDocument(startFeature='perf_lateral_length',
                                                                          opChain=[]),
                                                        y=OpChainDocument(startFeature='peak_rate', opChain=[])),
                                      name='Normalize',
                                      type='1_to_1',
                                      rangeStart=0.02,
                                      rangeEnd=0.98,
                                      diverged=False,
                                      multiplier=1.0,
                                      target={
                                          'acre_spacing': 100,
                                          'azimuth': 100,
                                          'before_income_tax_cash_flow': 14547.78,
                                          'casing_id': 100,
                                          'choke_size': 100,
                                          'cum_boe': 140.55,
                                          'cum_boe_per_perforated_interval': 30.2,
                                          'cum_gas': 281.4,
                                          'cum_gas_per_perforated_interval': 61.42,
                                          'cum_gor': 2577.96,
                                          'cum_mmcfge': 843.32,
                                          'cum_mmcfge_per_perforated_interval': 181.18,
                                          'cum_oil': 93.65,
                                          'cum_oil_per_perforated_interval': 19.96,
                                          'cum_water': 84.4,
                                          'cum_water_per_perforated_interval': 18.47,
                                          'custom_number_0': 100,
                                          'custom_number_1': 100,
                                          'custom_number_10': 100,
                                          'custom_number_11': 100,
                                          'custom_number_12': 100,
                                          'custom_number_13': 100,
                                          'custom_number_14': 100,
                                          'custom_number_15': 100,
                                          'custom_number_16': 100,
                                          'custom_number_17': 100,
                                          'custom_number_18': 100,
                                          'custom_number_19': 100,
                                          'custom_number_2': 100,
                                          'custom_number_3': 100,
                                          'custom_number_4': 100,
                                          'custom_number_5': 100,
                                          'custom_number_6': 100,
                                          'custom_number_7': 100,
                                          'custom_number_8': 100,
                                          'custom_number_9': 100,
                                          'distance_from_base_of_zone': 100,
                                          'distance_from_top_of_zone': 100,
                                          'elevation': 5483.2,
                                          'first_12_boe': 65.15,
                                          'first_12_boe_per_perforated_interval': 13.96,
                                          'first_12_gas': 97.03,
                                          'first_12_gas_per_perforated_interval': 21.07,
                                          'first_12_gor': 1739.13,
                                          'first_12_mmcfge': 390.89,
                                          'first_12_mmcfge_per_perforated_interval': 83.73,
                                          'first_12_oil': 48.98,
                                          'first_12_oil_per_perforated_interval': 10.44,
                                          'first_12_water': 39.29,
                                          'first_12_water_per_perforated_interval': 8.63,
                                          'first_6_boe': 35.53,
                                          'first_6_boe_per_perforated_interval': 7.74,
                                          'first_6_gas': 47.79,
                                          'first_6_gas_per_perforated_interval': 10.68,
                                          'first_6_gor': 1520.05,
                                          'first_6_mmcfge': 213.17,
                                          'first_6_mmcfge_per_perforated_interval': 46.44,
                                          'first_6_oil': 27.56,
                                          'first_6_oil_per_perforated_interval': 5.96,
                                          'first_6_water': 22.83,
                                          'first_6_water_per_perforated_interval': 5.06,
                                          'first_additive_volume': 100,
                                          'first_cluster_count': 100,
                                          'first_discount_cash_flow': 1944.38,
                                          'first_fluid_per_perforated_interval': 100,
                                          'first_fluid_volume': 100,
                                          'first_max_injection_pressure': 100,
                                          'first_max_injection_rate': 100,
                                          'first_prop_weight': 100,
                                          'first_proppant_per_fluid': 100,
                                          'first_proppant_per_perforated_interval': 100,
                                          'first_stage_count': 100,
                                          'first_test_flow_tbg_press': 100,
                                          'first_test_gas_vol': 100,
                                          'first_test_gor': 100,
                                          'first_test_oil_vol': 100,
                                          'first_test_water_vol': 100,
                                          'footage_in_landing_zone': 100,
                                          'formation_thickness_mean': 100,
                                          'gas_breakeven': 100,
                                          'gas_shrunk_eur': 100,
                                          'gas_shrunk_eur_over_pll': 100,
                                          'gas_specific_gravity': 100,
                                          'ground_elevation': 5461.81,
                                          'heelLatitude': 100,
                                          'heelLongitude': 100,
                                          'hz_well_spacing_any_zone': 100,
                                          'hz_well_spacing_same_zone': 100,
                                          'initial_respress': 100,
                                          'initial_restemp': 100,
                                          'irr': 580.55,
                                          'landing_zone_base': 100,
                                          'landing_zone_top': 100,
                                          'last_12_boe': 12.44,
                                          'last_12_boe_per_perforated_interval': 2.53,
                                          'last_12_gas': 34.17,
                                          'last_12_gas_per_perforated_interval': 6.9,
                                          'last_12_gor': 4855.07,
                                          'last_12_mmcfge': 74.61,
                                          'last_12_mmcfge_per_perforated_interval': 15.17,
                                          'last_12_oil': 6.74,
                                          'last_12_oil_per_perforated_interval': 1.38,
                                          'last_12_water': 5.82,
                                          'last_12_water_per_perforated_interval': 1.27,
                                          'last_month_boe': 0.98,
                                          'last_month_boe_per_perforated_interval': 0.2,
                                          'last_month_gas': 2.7,
                                          'last_month_gas_per_perforated_interval': 0.54,
                                          'last_month_gor': 4979.31,
                                          'last_month_mmcfge': 5.88,
                                          'last_month_mmcfge_per_perforated_interval': 1.2,
                                          'last_month_oil': 0.53,
                                          'last_month_oil_per_perforated_interval': 0.11,
                                          'last_month_water': 0.49,
                                          'last_month_water_per_perforated_interval': 0.11,
                                          'lateral_length': 4682,
                                          'lower_perforation': 12882.4,
                                          'matrix_permeability': 100,
                                          'measured_depth': 12925.2,
                                          'month_produced': 62.6,
                                          'ngl_shrunk_eur': 100,
                                          'ngl_shrunk_eur_over_pll': 100,
                                          'nri_oil': 100,
                                          'num_treatment_records': 0.4,
                                          'oil_api_gravity': 100,
                                          'oil_breakeven': 100,
                                          'oil_shrunk_eur': 100,
                                          'oil_shrunk_eur_over_pll': 100,
                                          'oil_specific_gravity': 40.44,
                                          'payout_duration': 18.4,
                                          'perf_lateral_length': 9000,
                                          'refrac_additive_volume': 100,
                                          'refrac_cluster_count': 100,
                                          'refrac_fluid_per_perforated_interval': 100,
                                          'refrac_fluid_volume': 100,
                                          'refrac_max_injection_pressure': 100,
                                          'refrac_max_injection_rate': 100,
                                          'refrac_prop_weight': 100,
                                          'refrac_proppant_per_fluid': 100,
                                          'refrac_proppant_per_perforated_interval': 100,
                                          'refrac_stage_count': 100,
                                          'stage_spacing': 100,
                                          'surfaceLatitude': 40.92,
                                          'surfaceLongitude': -104.61,
                                          'thickness': 100,
                                          'toeLatitude': 40.92,
                                          'toeLongitude': -104.62,
                                          'total_additive_volume': 100,
                                          'total_cluster_count': 100,
                                          'total_fluid_per_perforated_interval': 100,
                                          'total_fluid_volume': 0,
                                          'total_prop_weight': 0,
                                          'total_proppant_per_fluid': 100,
                                          'total_proppant_per_perforated_interval': 100,
                                          'total_stage_count': 100,
                                          'true_vertical_depth': 7970.4,
                                          'tubing_depth': 100,
                                          'tubing_id': 100,
                                          'undiscounted_roi': 100,
                                          'upper_perforation': 8302,
                                          'vt_well_spacing_any_zone': 100,
                                          'vt_well_spacing_same_zone': 100,
                                          'wi_oil': 100,
                                          'first_prop_weight/perf_lateral_length': 0.021832154396995897,
                                          'first_fluid_volume/perf_lateral_length': 0.021832154396995897,
                                          'first_prop_weight/perf_lateral_length/hz_well_spacing_same_zone':
                                          0.00021832154396995897,
                                          'first_fluid_volume/perf_lateral_length/hz_well_spacing_same_zone':
                                          0.00021832154396995897,
                                          'first_prop_weight/acre_spacing': 1,
                                          'first_fluid_volume/acre_spacing': 1,
                                          'peak_rate': 400
                                      },
                                      normalizationMin=0.0,
                                      normalizationMax=0.0,
                                      aValue=2.0861869844538434,
                                      bValue=-2197.770863592384),
                      normalizationType='eur_and_q_peak'),
        'target_eur':
        751157.9308657959,
        'target_q_peak':
        400,
        'apply_normalization':
        True
    }, [[{
        'start_idx': 44867,
        'q_start': 400.0,
        'end_idx': 50975,
        'q_end': 50.00573754264852,
        'b': 0.9,
        'D': 0.0010000269511898894,
        'D_eff': 0.27079999265299826,
        'slope': -1,
        'name': 'arps'
    }]]),
    ({
        'segments': [{
            'start_idx': 1,
            'q_start': 100,
            'end_idx': 1826,
            'q_end': 100,
            'c': 100,
            'slope': 0,
            'name': 'flat'
        }],
        'delta_index':
        np.array([44870]),
        'multipliers': {
            'eur': np.array([0.59531165]),
            'qPeak': np.array([0.87328618])
        },
        'steps':
        StepsDocument(eur=StepsItem(key='normalize',
                                    base=BaseDocument(key='eur_pll',
                                                      x=OpChainDocument(startFeature='perf_lateral_length', opChain=[]),
                                                      y=OpChainDocument(startFeature='eur', opChain=[])),
                                    name='Normalize',
                                    type='power_law_fit',
                                    rangeStart=0.02,
                                    rangeEnd=0.98,
                                    diverged=False,
                                    multiplier=1.0,
                                    target={
                                        'acre_spacing': 100,
                                        'azimuth': 100,
                                        'before_income_tax_cash_flow': 14547.78,
                                        'casing_id': 100,
                                        'choke_size': 100,
                                        'cum_boe': 140.55,
                                        'cum_boe_per_perforated_interval': 30.2,
                                        'cum_gas': 281.4,
                                        'cum_gas_per_perforated_interval': 61.42,
                                        'cum_gor': 2577.96,
                                        'cum_mmcfge': 843.32,
                                        'cum_mmcfge_per_perforated_interval': 181.18,
                                        'cum_oil': 93.65,
                                        'cum_oil_per_perforated_interval': 19.96,
                                        'cum_water': 84.4,
                                        'cum_water_per_perforated_interval': 18.47,
                                        'custom_number_0': 100,
                                        'custom_number_1': 100,
                                        'custom_number_10': 100,
                                        'custom_number_11': 100,
                                        'custom_number_12': 100,
                                        'custom_number_13': 100,
                                        'custom_number_14': 100,
                                        'custom_number_15': 100,
                                        'custom_number_16': 100,
                                        'custom_number_17': 100,
                                        'custom_number_18': 100,
                                        'custom_number_19': 100,
                                        'custom_number_2': 100,
                                        'custom_number_3': 100,
                                        'custom_number_4': 100,
                                        'custom_number_5': 100,
                                        'custom_number_6': 100,
                                        'custom_number_7': 100,
                                        'custom_number_8': 100,
                                        'custom_number_9': 100,
                                        'distance_from_base_of_zone': 100,
                                        'distance_from_top_of_zone': 100,
                                        'elevation': 5483.2,
                                        'first_12_boe': 65.15,
                                        'first_12_boe_per_perforated_interval': 13.96,
                                        'first_12_gas': 97.03,
                                        'first_12_gas_per_perforated_interval': 21.07,
                                        'first_12_gor': 1739.13,
                                        'first_12_mmcfge': 390.89,
                                        'first_12_mmcfge_per_perforated_interval': 83.73,
                                        'first_12_oil': 48.98,
                                        'first_12_oil_per_perforated_interval': 10.44,
                                        'first_12_water': 39.29,
                                        'first_12_water_per_perforated_interval': 8.63,
                                        'first_6_boe': 35.53,
                                        'first_6_boe_per_perforated_interval': 7.74,
                                        'first_6_gas': 47.79,
                                        'first_6_gas_per_perforated_interval': 10.68,
                                        'first_6_gor': 1520.05,
                                        'first_6_mmcfge': 213.17,
                                        'first_6_mmcfge_per_perforated_interval': 46.44,
                                        'first_6_oil': 27.56,
                                        'first_6_oil_per_perforated_interval': 5.96,
                                        'first_6_water': 22.83,
                                        'first_6_water_per_perforated_interval': 5.06,
                                        'first_additive_volume': 100,
                                        'first_cluster_count': 100,
                                        'first_discount_cash_flow': 1944.38,
                                        'first_fluid_per_perforated_interval': 100,
                                        'first_fluid_volume': 100,
                                        'first_max_injection_pressure': 100,
                                        'first_max_injection_rate': 100,
                                        'first_prop_weight': 100,
                                        'first_proppant_per_fluid': 100,
                                        'first_proppant_per_perforated_interval': 100,
                                        'first_stage_count': 100,
                                        'first_test_flow_tbg_press': 100,
                                        'first_test_gas_vol': 100,
                                        'first_test_gor': 100,
                                        'first_test_oil_vol': 100,
                                        'first_test_water_vol': 100,
                                        'footage_in_landing_zone': 100,
                                        'formation_thickness_mean': 100,
                                        'gas_breakeven': 100,
                                        'gas_shrunk_eur': 100,
                                        'gas_shrunk_eur_over_pll': 100,
                                        'gas_specific_gravity': 100,
                                        'ground_elevation': 5461.81,
                                        'heelLatitude': 100,
                                        'heelLongitude': 100,
                                        'hz_well_spacing_any_zone': 100,
                                        'hz_well_spacing_same_zone': 100,
                                        'initial_respress': 100,
                                        'initial_restemp': 100,
                                        'irr': 580.55,
                                        'landing_zone_base': 100,
                                        'landing_zone_top': 100,
                                        'last_12_boe': 12.44,
                                        'last_12_boe_per_perforated_interval': 2.53,
                                        'last_12_gas': 34.17,
                                        'last_12_gas_per_perforated_interval': 6.9,
                                        'last_12_gor': 4855.07,
                                        'last_12_mmcfge': 74.61,
                                        'last_12_mmcfge_per_perforated_interval': 15.17,
                                        'last_12_oil': 6.74,
                                        'last_12_oil_per_perforated_interval': 1.38,
                                        'last_12_water': 5.82,
                                        'last_12_water_per_perforated_interval': 1.27,
                                        'last_month_boe': 0.98,
                                        'last_month_boe_per_perforated_interval': 0.2,
                                        'last_month_gas': 2.7,
                                        'last_month_gas_per_perforated_interval': 0.54,
                                        'last_month_gor': 4979.31,
                                        'last_month_mmcfge': 5.88,
                                        'last_month_mmcfge_per_perforated_interval': 1.2,
                                        'last_month_oil': 0.53,
                                        'last_month_oil_per_perforated_interval': 0.11,
                                        'last_month_water': 0.49,
                                        'last_month_water_per_perforated_interval': 0.11,
                                        'lateral_length': 4682,
                                        'lower_perforation': 12882.4,
                                        'matrix_permeability': 100,
                                        'measured_depth': 12925.2,
                                        'month_produced': 62.6,
                                        'ngl_shrunk_eur': 100,
                                        'ngl_shrunk_eur_over_pll': 100,
                                        'nri_oil': 100,
                                        'num_treatment_records': 0.4,
                                        'oil_api_gravity': 100,
                                        'oil_breakeven': 100,
                                        'oil_shrunk_eur': 100,
                                        'oil_shrunk_eur_over_pll': 100,
                                        'oil_specific_gravity': 40.44,
                                        'payout_duration': 18.4,
                                        'perf_lateral_length': 4580.4,
                                        'refrac_additive_volume': 100,
                                        'refrac_cluster_count': 100,
                                        'refrac_fluid_per_perforated_interval': 100,
                                        'refrac_fluid_volume': 100,
                                        'refrac_max_injection_pressure': 100,
                                        'refrac_max_injection_rate': 100,
                                        'refrac_prop_weight': 100,
                                        'refrac_proppant_per_fluid': 100,
                                        'refrac_proppant_per_perforated_interval': 100,
                                        'refrac_stage_count': 100,
                                        'stage_spacing': 100,
                                        'surfaceLatitude': 40.92,
                                        'surfaceLongitude': -104.61,
                                        'thickness': 100,
                                        'toeLatitude': 40.92,
                                        'toeLongitude': -104.62,
                                        'total_additive_volume': 100,
                                        'total_cluster_count': 100,
                                        'total_fluid_per_perforated_interval': 100,
                                        'total_fluid_volume': 0,
                                        'total_prop_weight': 0,
                                        'total_proppant_per_fluid': 100,
                                        'total_proppant_per_perforated_interval': 100,
                                        'total_stage_count': 100,
                                        'true_vertical_depth': 7970.4,
                                        'tubing_depth': 100,
                                        'tubing_id': 100,
                                        'undiscounted_roi': 100,
                                        'upper_perforation': 8302,
                                        'vt_well_spacing_any_zone': 100,
                                        'vt_well_spacing_same_zone': 100,
                                        'wi_oil': 100,
                                        'first_prop_weight/perf_lateral_length': 0.021832154396995897,
                                        'first_fluid_volume/perf_lateral_length': 0.021832154396995897,
                                        'first_prop_weight/perf_lateral_length/hz_well_spacing_same_zone':
                                        0.00021832154396995897,
                                        'first_fluid_volume/perf_lateral_length/hz_well_spacing_same_zone':
                                        0.00021832154396995897,
                                        'first_prop_weight/acre_spacing': 1,
                                        'first_fluid_volume/acre_spacing': 1,
                                        'eur': 182600.0
                                    },
                                    normalizationMin=0.0,
                                    normalizationMax=0.0,
                                    aValue=6.8508412023135055,
                                    bValue=1.3165307635403267),
                      qPeak=StepsItem(key='normalize',
                                      base=BaseDocument(key='peak_pll',
                                                        x=OpChainDocument(startFeature='perf_lateral_length',
                                                                          opChain=[]),
                                                        y=OpChainDocument(startFeature='peak_rate', opChain=[])),
                                      name='Normalize',
                                      type='linear',
                                      rangeStart=0.02,
                                      rangeEnd=0.98,
                                      diverged=False,
                                      multiplier=1.0,
                                      target={
                                          'acre_spacing': 100,
                                          'azimuth': 100,
                                          'before_income_tax_cash_flow': 14547.78,
                                          'casing_id': 100,
                                          'choke_size': 100,
                                          'cum_boe': 140.55,
                                          'cum_boe_per_perforated_interval': 30.2,
                                          'cum_gas': 281.4,
                                          'cum_gas_per_perforated_interval': 61.42,
                                          'cum_gor': 2577.96,
                                          'cum_mmcfge': 843.32,
                                          'cum_mmcfge_per_perforated_interval': 181.18,
                                          'cum_oil': 93.65,
                                          'cum_oil_per_perforated_interval': 19.96,
                                          'cum_water': 84.4,
                                          'cum_water_per_perforated_interval': 18.47,
                                          'custom_number_0': 100,
                                          'custom_number_1': 100,
                                          'custom_number_10': 100,
                                          'custom_number_11': 100,
                                          'custom_number_12': 100,
                                          'custom_number_13': 100,
                                          'custom_number_14': 100,
                                          'custom_number_15': 100,
                                          'custom_number_16': 100,
                                          'custom_number_17': 100,
                                          'custom_number_18': 100,
                                          'custom_number_19': 100,
                                          'custom_number_2': 100,
                                          'custom_number_3': 100,
                                          'custom_number_4': 100,
                                          'custom_number_5': 100,
                                          'custom_number_6': 100,
                                          'custom_number_7': 100,
                                          'custom_number_8': 100,
                                          'custom_number_9': 100,
                                          'distance_from_base_of_zone': 100,
                                          'distance_from_top_of_zone': 100,
                                          'elevation': 5483.2,
                                          'first_12_boe': 65.15,
                                          'first_12_boe_per_perforated_interval': 13.96,
                                          'first_12_gas': 97.03,
                                          'first_12_gas_per_perforated_interval': 21.07,
                                          'first_12_gor': 1739.13,
                                          'first_12_mmcfge': 390.89,
                                          'first_12_mmcfge_per_perforated_interval': 83.73,
                                          'first_12_oil': 48.98,
                                          'first_12_oil_per_perforated_interval': 10.44,
                                          'first_12_water': 39.29,
                                          'first_12_water_per_perforated_interval': 8.63,
                                          'first_6_boe': 35.53,
                                          'first_6_boe_per_perforated_interval': 7.74,
                                          'first_6_gas': 47.79,
                                          'first_6_gas_per_perforated_interval': 10.68,
                                          'first_6_gor': 1520.05,
                                          'first_6_mmcfge': 213.17,
                                          'first_6_mmcfge_per_perforated_interval': 46.44,
                                          'first_6_oil': 27.56,
                                          'first_6_oil_per_perforated_interval': 5.96,
                                          'first_6_water': 22.83,
                                          'first_6_water_per_perforated_interval': 5.06,
                                          'first_additive_volume': 100,
                                          'first_cluster_count': 100,
                                          'first_discount_cash_flow': 1944.38,
                                          'first_fluid_per_perforated_interval': 100,
                                          'first_fluid_volume': 100,
                                          'first_max_injection_pressure': 100,
                                          'first_max_injection_rate': 100,
                                          'first_prop_weight': 100,
                                          'first_proppant_per_fluid': 100,
                                          'first_proppant_per_perforated_interval': 100,
                                          'first_stage_count': 100,
                                          'first_test_flow_tbg_press': 100,
                                          'first_test_gas_vol': 100,
                                          'first_test_gor': 100,
                                          'first_test_oil_vol': 100,
                                          'first_test_water_vol': 100,
                                          'footage_in_landing_zone': 100,
                                          'formation_thickness_mean': 100,
                                          'gas_breakeven': 100,
                                          'gas_shrunk_eur': 100,
                                          'gas_shrunk_eur_over_pll': 100,
                                          'gas_specific_gravity': 100,
                                          'ground_elevation': 5461.81,
                                          'heelLatitude': 100,
                                          'heelLongitude': 100,
                                          'hz_well_spacing_any_zone': 100,
                                          'hz_well_spacing_same_zone': 100,
                                          'initial_respress': 100,
                                          'initial_restemp': 100,
                                          'irr': 580.55,
                                          'landing_zone_base': 100,
                                          'landing_zone_top': 100,
                                          'last_12_boe': 12.44,
                                          'last_12_boe_per_perforated_interval': 2.53,
                                          'last_12_gas': 34.17,
                                          'last_12_gas_per_perforated_interval': 6.9,
                                          'last_12_gor': 4855.07,
                                          'last_12_mmcfge': 74.61,
                                          'last_12_mmcfge_per_perforated_interval': 15.17,
                                          'last_12_oil': 6.74,
                                          'last_12_oil_per_perforated_interval': 1.38,
                                          'last_12_water': 5.82,
                                          'last_12_water_per_perforated_interval': 1.27,
                                          'last_month_boe': 0.98,
                                          'last_month_boe_per_perforated_interval': 0.2,
                                          'last_month_gas': 2.7,
                                          'last_month_gas_per_perforated_interval': 0.54,
                                          'last_month_gor': 4979.31,
                                          'last_month_mmcfge': 5.88,
                                          'last_month_mmcfge_per_perforated_interval': 1.2,
                                          'last_month_oil': 0.53,
                                          'last_month_oil_per_perforated_interval': 0.11,
                                          'last_month_water': 0.49,
                                          'last_month_water_per_perforated_interval': 0.11,
                                          'lateral_length': 4682,
                                          'lower_perforation': 12882.4,
                                          'matrix_permeability': 100,
                                          'measured_depth': 12925.2,
                                          'month_produced': 62.6,
                                          'ngl_shrunk_eur': 100,
                                          'ngl_shrunk_eur_over_pll': 100,
                                          'nri_oil': 100,
                                          'num_treatment_records': 0.4,
                                          'oil_api_gravity': 100,
                                          'oil_breakeven': 100,
                                          'oil_shrunk_eur': 100,
                                          'oil_shrunk_eur_over_pll': 100,
                                          'oil_specific_gravity': 40.44,
                                          'payout_duration': 18.4,
                                          'perf_lateral_length': 4580.4,
                                          'refrac_additive_volume': 100,
                                          'refrac_cluster_count': 100,
                                          'refrac_fluid_per_perforated_interval': 100,
                                          'refrac_fluid_volume': 100,
                                          'refrac_max_injection_pressure': 100,
                                          'refrac_max_injection_rate': 100,
                                          'refrac_prop_weight': 100,
                                          'refrac_proppant_per_fluid': 100,
                                          'refrac_proppant_per_perforated_interval': 100,
                                          'refrac_stage_count': 100,
                                          'stage_spacing': 100,
                                          'surfaceLatitude': 40.92,
                                          'surfaceLongitude': -104.61,
                                          'thickness': 100,
                                          'toeLatitude': 40.92,
                                          'toeLongitude': -104.62,
                                          'total_additive_volume': 100,
                                          'total_cluster_count': 100,
                                          'total_fluid_per_perforated_interval': 100,
                                          'total_fluid_volume': 0,
                                          'total_prop_weight': 0,
                                          'total_proppant_per_fluid': 100,
                                          'total_proppant_per_perforated_interval': 100,
                                          'total_stage_count': 100,
                                          'true_vertical_depth': 7970.4,
                                          'tubing_depth': 100,
                                          'tubing_id': 100,
                                          'undiscounted_roi': 100,
                                          'upper_perforation': 8302,
                                          'vt_well_spacing_any_zone': 100,
                                          'vt_well_spacing_same_zone': 100,
                                          'wi_oil': 100,
                                          'first_prop_weight/perf_lateral_length': 0.021832154396995897,
                                          'first_fluid_volume/perf_lateral_length': 0.021832154396995897,
                                          'first_prop_weight/perf_lateral_length/hz_well_spacing_same_zone':
                                          0.00021832154396995897,
                                          'first_fluid_volume/perf_lateral_length/hz_well_spacing_same_zone':
                                          0.00021832154396995897,
                                          'first_prop_weight/acre_spacing': 1,
                                          'first_fluid_volume/acre_spacing': 1,
                                          'peak_rate': 100
                                      },
                                      normalizationMin=0.0,
                                      normalizationMax=0.0,
                                      aValue=2.0861869844538434,
                                      bValue=-2197.770863592384),
                      normalizationType='eur_and_q_peak'),
        'target_eur':
        182600.0,
        'target_q_peak':
        100,
        'apply_normalization':
        True
    }, [[{
        'start_idx': 44871,
        'q_start': 59.531164998371935,
        'end_idx': 46696,
        'q_end': 59.531164998371935,
        'c': 59.531164998371935,
        'slope': 0,
        'name': 'flat'
    }]]),
    ({
        'segments': [{
            'start_idx': 1,
            'q_start': 0,
            'end_idx': 1826,
            'q_end': 0,
            'slope': 0,
            'name': 'empty'
        }],
        'delta_index':
        np.array([44870]),
        'multipliers': {
            'eur': np.array([1.]),
            'qPeak': np.array([1.])
        },
        'steps':
        StepsDocument(eur=StepsItem(key='normalize',
                                    base=BaseDocument(key='eur_pll',
                                                      x=OpChainDocument(startFeature='perf_lateral_length', opChain=[]),
                                                      y=OpChainDocument(startFeature='eur', opChain=[])),
                                    name='Normalize',
                                    type='1_to_1',
                                    rangeStart=0.02,
                                    rangeEnd=0.98,
                                    diverged=False,
                                    multiplier=1.0,
                                    target={
                                        'acre_spacing': 100,
                                        'azimuth': 100,
                                        'before_income_tax_cash_flow': 14547.78,
                                        'casing_id': 100,
                                        'choke_size': 100,
                                        'cum_boe': 140.55,
                                        'cum_boe_per_perforated_interval': 30.2,
                                        'cum_gas': 281.4,
                                        'cum_gas_per_perforated_interval': 61.42,
                                        'cum_gor': 2577.96,
                                        'cum_mmcfge': 843.32,
                                        'cum_mmcfge_per_perforated_interval': 181.18,
                                        'cum_oil': 93.65,
                                        'cum_oil_per_perforated_interval': 19.96,
                                        'cum_water': 84.4,
                                        'cum_water_per_perforated_interval': 18.47,
                                        'custom_number_0': 100,
                                        'custom_number_1': 100,
                                        'custom_number_10': 100,
                                        'custom_number_11': 100,
                                        'custom_number_12': 100,
                                        'custom_number_13': 100,
                                        'custom_number_14': 100,
                                        'custom_number_15': 100,
                                        'custom_number_16': 100,
                                        'custom_number_17': 100,
                                        'custom_number_18': 100,
                                        'custom_number_19': 100,
                                        'custom_number_2': 100,
                                        'custom_number_3': 100,
                                        'custom_number_4': 100,
                                        'custom_number_5': 100,
                                        'custom_number_6': 100,
                                        'custom_number_7': 100,
                                        'custom_number_8': 100,
                                        'custom_number_9': 100,
                                        'distance_from_base_of_zone': 100,
                                        'distance_from_top_of_zone': 100,
                                        'elevation': 5483.2,
                                        'first_12_boe': 65.15,
                                        'first_12_boe_per_perforated_interval': 13.96,
                                        'first_12_gas': 97.03,
                                        'first_12_gas_per_perforated_interval': 21.07,
                                        'first_12_gor': 1739.13,
                                        'first_12_mmcfge': 390.89,
                                        'first_12_mmcfge_per_perforated_interval': 83.73,
                                        'first_12_oil': 48.98,
                                        'first_12_oil_per_perforated_interval': 10.44,
                                        'first_12_water': 39.29,
                                        'first_12_water_per_perforated_interval': 8.63,
                                        'first_6_boe': 35.53,
                                        'first_6_boe_per_perforated_interval': 7.74,
                                        'first_6_gas': 47.79,
                                        'first_6_gas_per_perforated_interval': 10.68,
                                        'first_6_gor': 1520.05,
                                        'first_6_mmcfge': 213.17,
                                        'first_6_mmcfge_per_perforated_interval': 46.44,
                                        'first_6_oil': 27.56,
                                        'first_6_oil_per_perforated_interval': 5.96,
                                        'first_6_water': 22.83,
                                        'first_6_water_per_perforated_interval': 5.06,
                                        'first_additive_volume': 100,
                                        'first_cluster_count': 100,
                                        'first_discount_cash_flow': 1944.38,
                                        'first_fluid_per_perforated_interval': 100,
                                        'first_fluid_volume': 100,
                                        'first_max_injection_pressure': 100,
                                        'first_max_injection_rate': 100,
                                        'first_prop_weight': 100,
                                        'first_proppant_per_fluid': 100,
                                        'first_proppant_per_perforated_interval': 100,
                                        'first_stage_count': 100,
                                        'first_test_flow_tbg_press': 100,
                                        'first_test_gas_vol': 100,
                                        'first_test_gor': 100,
                                        'first_test_oil_vol': 100,
                                        'first_test_water_vol': 100,
                                        'footage_in_landing_zone': 100,
                                        'formation_thickness_mean': 100,
                                        'gas_breakeven': 100,
                                        'gas_shrunk_eur': 100,
                                        'gas_shrunk_eur_over_pll': 100,
                                        'gas_specific_gravity': 100,
                                        'ground_elevation': 5461.81,
                                        'heelLatitude': 100,
                                        'heelLongitude': 100,
                                        'hz_well_spacing_any_zone': 100,
                                        'hz_well_spacing_same_zone': 100,
                                        'initial_respress': 100,
                                        'initial_restemp': 100,
                                        'irr': 580.55,
                                        'landing_zone_base': 100,
                                        'landing_zone_top': 100,
                                        'last_12_boe': 12.44,
                                        'last_12_boe_per_perforated_interval': 2.53,
                                        'last_12_gas': 34.17,
                                        'last_12_gas_per_perforated_interval': 6.9,
                                        'last_12_gor': 4855.07,
                                        'last_12_mmcfge': 74.61,
                                        'last_12_mmcfge_per_perforated_interval': 15.17,
                                        'last_12_oil': 6.74,
                                        'last_12_oil_per_perforated_interval': 1.38,
                                        'last_12_water': 5.82,
                                        'last_12_water_per_perforated_interval': 1.27,
                                        'last_month_boe': 0.98,
                                        'last_month_boe_per_perforated_interval': 0.2,
                                        'last_month_gas': 2.7,
                                        'last_month_gas_per_perforated_interval': 0.54,
                                        'last_month_gor': 4979.31,
                                        'last_month_mmcfge': 5.88,
                                        'last_month_mmcfge_per_perforated_interval': 1.2,
                                        'last_month_oil': 0.53,
                                        'last_month_oil_per_perforated_interval': 0.11,
                                        'last_month_water': 0.49,
                                        'last_month_water_per_perforated_interval': 0.11,
                                        'lateral_length': 4682,
                                        'lower_perforation': 12882.4,
                                        'matrix_permeability': 100,
                                        'measured_depth': 12925.2,
                                        'month_produced': 62.6,
                                        'ngl_shrunk_eur': 100,
                                        'ngl_shrunk_eur_over_pll': 100,
                                        'nri_oil': 100,
                                        'num_treatment_records': 0.4,
                                        'oil_api_gravity': 100,
                                        'oil_breakeven': 100,
                                        'oil_shrunk_eur': 100,
                                        'oil_shrunk_eur_over_pll': 100,
                                        'oil_specific_gravity': 40.44,
                                        'payout_duration': 18.4,
                                        'perf_lateral_length': 4580.4,
                                        'refrac_additive_volume': 100,
                                        'refrac_cluster_count': 100,
                                        'refrac_fluid_per_perforated_interval': 100,
                                        'refrac_fluid_volume': 100,
                                        'refrac_max_injection_pressure': 100,
                                        'refrac_max_injection_rate': 100,
                                        'refrac_prop_weight': 100,
                                        'refrac_proppant_per_fluid': 100,
                                        'refrac_proppant_per_perforated_interval': 100,
                                        'refrac_stage_count': 100,
                                        'stage_spacing': 100,
                                        'surfaceLatitude': 40.92,
                                        'surfaceLongitude': -104.61,
                                        'thickness': 100,
                                        'toeLatitude': 40.92,
                                        'toeLongitude': -104.62,
                                        'total_additive_volume': 100,
                                        'total_cluster_count': 100,
                                        'total_fluid_per_perforated_interval': 100,
                                        'total_fluid_volume': 0,
                                        'total_prop_weight': 0,
                                        'total_proppant_per_fluid': 100,
                                        'total_proppant_per_perforated_interval': 100,
                                        'total_stage_count': 100,
                                        'true_vertical_depth': 7970.4,
                                        'tubing_depth': 100,
                                        'tubing_id': 100,
                                        'undiscounted_roi': 100,
                                        'upper_perforation': 8302,
                                        'vt_well_spacing_any_zone': 100,
                                        'vt_well_spacing_same_zone': 100,
                                        'wi_oil': 100,
                                        'first_prop_weight/perf_lateral_length': 0.021832154396995897,
                                        'first_fluid_volume/perf_lateral_length': 0.021832154396995897,
                                        'first_prop_weight/perf_lateral_length/hz_well_spacing_same_zone':
                                        0.00021832154396995897,
                                        'first_fluid_volume/perf_lateral_length/hz_well_spacing_same_zone':
                                        0.00021832154396995897,
                                        'first_prop_weight/acre_spacing': 1,
                                        'first_fluid_volume/acre_spacing': 1,
                                        'eur': 0.0
                                    },
                                    normalizationMin=0.0,
                                    normalizationMax=0.0,
                                    aValue=147.39255237339438,
                                    bValue=-219877.55389907834),
                      qPeak=StepsItem(key='normalize',
                                      base=BaseDocument(key='peak_pll',
                                                        x=OpChainDocument(startFeature='perf_lateral_length',
                                                                          opChain=[]),
                                                        y=OpChainDocument(startFeature='peak_rate', opChain=[])),
                                      name='Normalize',
                                      type='1_to_1',
                                      rangeStart=0.02,
                                      rangeEnd=0.98,
                                      diverged=False,
                                      multiplier=1.0,
                                      target={
                                          'acre_spacing': 100,
                                          'azimuth': 100,
                                          'before_income_tax_cash_flow': 14547.78,
                                          'casing_id': 100,
                                          'choke_size': 100,
                                          'cum_boe': 140.55,
                                          'cum_boe_per_perforated_interval': 30.2,
                                          'cum_gas': 281.4,
                                          'cum_gas_per_perforated_interval': 61.42,
                                          'cum_gor': 2577.96,
                                          'cum_mmcfge': 843.32,
                                          'cum_mmcfge_per_perforated_interval': 181.18,
                                          'cum_oil': 93.65,
                                          'cum_oil_per_perforated_interval': 19.96,
                                          'cum_water': 84.4,
                                          'cum_water_per_perforated_interval': 18.47,
                                          'custom_number_0': 100,
                                          'custom_number_1': 100,
                                          'custom_number_10': 100,
                                          'custom_number_11': 100,
                                          'custom_number_12': 100,
                                          'custom_number_13': 100,
                                          'custom_number_14': 100,
                                          'custom_number_15': 100,
                                          'custom_number_16': 100,
                                          'custom_number_17': 100,
                                          'custom_number_18': 100,
                                          'custom_number_19': 100,
                                          'custom_number_2': 100,
                                          'custom_number_3': 100,
                                          'custom_number_4': 100,
                                          'custom_number_5': 100,
                                          'custom_number_6': 100,
                                          'custom_number_7': 100,
                                          'custom_number_8': 100,
                                          'custom_number_9': 100,
                                          'distance_from_base_of_zone': 100,
                                          'distance_from_top_of_zone': 100,
                                          'elevation': 5483.2,
                                          'first_12_boe': 65.15,
                                          'first_12_boe_per_perforated_interval': 13.96,
                                          'first_12_gas': 97.03,
                                          'first_12_gas_per_perforated_interval': 21.07,
                                          'first_12_gor': 1739.13,
                                          'first_12_mmcfge': 390.89,
                                          'first_12_mmcfge_per_perforated_interval': 83.73,
                                          'first_12_oil': 48.98,
                                          'first_12_oil_per_perforated_interval': 10.44,
                                          'first_12_water': 39.29,
                                          'first_12_water_per_perforated_interval': 8.63,
                                          'first_6_boe': 35.53,
                                          'first_6_boe_per_perforated_interval': 7.74,
                                          'first_6_gas': 47.79,
                                          'first_6_gas_per_perforated_interval': 10.68,
                                          'first_6_gor': 1520.05,
                                          'first_6_mmcfge': 213.17,
                                          'first_6_mmcfge_per_perforated_interval': 46.44,
                                          'first_6_oil': 27.56,
                                          'first_6_oil_per_perforated_interval': 5.96,
                                          'first_6_water': 22.83,
                                          'first_6_water_per_perforated_interval': 5.06,
                                          'first_additive_volume': 100,
                                          'first_cluster_count': 100,
                                          'first_discount_cash_flow': 1944.38,
                                          'first_fluid_per_perforated_interval': 100,
                                          'first_fluid_volume': 100,
                                          'first_max_injection_pressure': 100,
                                          'first_max_injection_rate': 100,
                                          'first_prop_weight': 100,
                                          'first_proppant_per_fluid': 100,
                                          'first_proppant_per_perforated_interval': 100,
                                          'first_stage_count': 100,
                                          'first_test_flow_tbg_press': 100,
                                          'first_test_gas_vol': 100,
                                          'first_test_gor': 100,
                                          'first_test_oil_vol': 100,
                                          'first_test_water_vol': 100,
                                          'footage_in_landing_zone': 100,
                                          'formation_thickness_mean': 100,
                                          'gas_breakeven': 100,
                                          'gas_shrunk_eur': 100,
                                          'gas_shrunk_eur_over_pll': 100,
                                          'gas_specific_gravity': 100,
                                          'ground_elevation': 5461.81,
                                          'heelLatitude': 100,
                                          'heelLongitude': 100,
                                          'hz_well_spacing_any_zone': 100,
                                          'hz_well_spacing_same_zone': 100,
                                          'initial_respress': 100,
                                          'initial_restemp': 100,
                                          'irr': 580.55,
                                          'landing_zone_base': 100,
                                          'landing_zone_top': 100,
                                          'last_12_boe': 12.44,
                                          'last_12_boe_per_perforated_interval': 2.53,
                                          'last_12_gas': 34.17,
                                          'last_12_gas_per_perforated_interval': 6.9,
                                          'last_12_gor': 4855.07,
                                          'last_12_mmcfge': 74.61,
                                          'last_12_mmcfge_per_perforated_interval': 15.17,
                                          'last_12_oil': 6.74,
                                          'last_12_oil_per_perforated_interval': 1.38,
                                          'last_12_water': 5.82,
                                          'last_12_water_per_perforated_interval': 1.27,
                                          'last_month_boe': 0.98,
                                          'last_month_boe_per_perforated_interval': 0.2,
                                          'last_month_gas': 2.7,
                                          'last_month_gas_per_perforated_interval': 0.54,
                                          'last_month_gor': 4979.31,
                                          'last_month_mmcfge': 5.88,
                                          'last_month_mmcfge_per_perforated_interval': 1.2,
                                          'last_month_oil': 0.53,
                                          'last_month_oil_per_perforated_interval': 0.11,
                                          'last_month_water': 0.49,
                                          'last_month_water_per_perforated_interval': 0.11,
                                          'lateral_length': 4682,
                                          'lower_perforation': 12882.4,
                                          'matrix_permeability': 100,
                                          'measured_depth': 12925.2,
                                          'month_produced': 62.6,
                                          'ngl_shrunk_eur': 100,
                                          'ngl_shrunk_eur_over_pll': 100,
                                          'nri_oil': 100,
                                          'num_treatment_records': 0.4,
                                          'oil_api_gravity': 100,
                                          'oil_breakeven': 100,
                                          'oil_shrunk_eur': 100,
                                          'oil_shrunk_eur_over_pll': 100,
                                          'oil_specific_gravity': 40.44,
                                          'payout_duration': 18.4,
                                          'perf_lateral_length': 4580.4,
                                          'refrac_additive_volume': 100,
                                          'refrac_cluster_count': 100,
                                          'refrac_fluid_per_perforated_interval': 100,
                                          'refrac_fluid_volume': 100,
                                          'refrac_max_injection_pressure': 100,
                                          'refrac_max_injection_rate': 100,
                                          'refrac_prop_weight': 100,
                                          'refrac_proppant_per_fluid': 100,
                                          'refrac_proppant_per_perforated_interval': 100,
                                          'refrac_stage_count': 100,
                                          'stage_spacing': 100,
                                          'surfaceLatitude': 40.92,
                                          'surfaceLongitude': -104.61,
                                          'thickness': 100,
                                          'toeLatitude': 40.92,
                                          'toeLongitude': -104.62,
                                          'total_additive_volume': 100,
                                          'total_cluster_count': 100,
                                          'total_fluid_per_perforated_interval': 100,
                                          'total_fluid_volume': 0,
                                          'total_prop_weight': 0,
                                          'total_proppant_per_fluid': 100,
                                          'total_proppant_per_perforated_interval': 100,
                                          'total_stage_count': 100,
                                          'true_vertical_depth': 7970.4,
                                          'tubing_depth': 100,
                                          'tubing_id': 100,
                                          'undiscounted_roi': 100,
                                          'upper_perforation': 8302,
                                          'vt_well_spacing_any_zone': 100,
                                          'vt_well_spacing_same_zone': 100,
                                          'wi_oil': 100,
                                          'first_prop_weight/perf_lateral_length': 0.021832154396995897,
                                          'first_fluid_volume/perf_lateral_length': 0.021832154396995897,
                                          'first_prop_weight/perf_lateral_length/hz_well_spacing_same_zone':
                                          0.00021832154396995897,
                                          'first_fluid_volume/perf_lateral_length/hz_well_spacing_same_zone':
                                          0.00021832154396995897,
                                          'first_prop_weight/acre_spacing': 1,
                                          'first_fluid_volume/acre_spacing': 1,
                                          'peak_rate': 0
                                      },
                                      normalizationMin=0.0,
                                      normalizationMax=0.0,
                                      aValue=2.0861869844538434,
                                      bValue=-2197.770863592384),
                      normalizationType='eur_and_q_peak'),
        'target_eur':
        0.0,
        'target_q_peak':
        0,
        'apply_normalization':
        True
    }, [[{
        'start_idx': 44871,
        'q_start': 0,
        'end_idx': 46696,
        'q_end': 0,
        'slope': 0,
        'name': 'empty'
    }]]),
    ({
        'segments': [{
            'start_idx': 1,
            'q_start': 250,
            'end_idx': 2000,
            'q_end': 2,
            'D': 0.002415364550926614,
            'D_eff': 0.5861335336466773,
            'slope': -1,
            'name': 'exp_dec'
        }],
        'delta_index':
        np.array([44870]),
        'multipliers': {
            'eur': np.array([0.16785116]),
            'qPeak': np.array([0.87328618])
        },
        'steps':
        StepsDocument(eur=StepsItem(key='normalize',
                                    base=BaseDocument(key='eur_pll',
                                                      x=OpChainDocument(startFeature='perf_lateral_length', opChain=[]),
                                                      y=OpChainDocument(startFeature='eur', opChain=[])),
                                    name='Normalize',
                                    type='linear',
                                    rangeStart=0.02,
                                    rangeEnd=0.98,
                                    diverged=False,
                                    multiplier=1.0,
                                    target={
                                        'acre_spacing': 100,
                                        'azimuth': 100,
                                        'before_income_tax_cash_flow': 14547.78,
                                        'casing_id': 100,
                                        'choke_size': 100,
                                        'cum_boe': 140.55,
                                        'cum_boe_per_perforated_interval': 30.2,
                                        'cum_gas': 281.4,
                                        'cum_gas_per_perforated_interval': 61.42,
                                        'cum_gor': 2577.96,
                                        'cum_mmcfge': 843.32,
                                        'cum_mmcfge_per_perforated_interval': 181.18,
                                        'cum_oil': 93.65,
                                        'cum_oil_per_perforated_interval': 19.96,
                                        'cum_water': 84.4,
                                        'cum_water_per_perforated_interval': 18.47,
                                        'custom_number_0': 100,
                                        'custom_number_1': 100,
                                        'custom_number_10': 100,
                                        'custom_number_11': 100,
                                        'custom_number_12': 100,
                                        'custom_number_13': 100,
                                        'custom_number_14': 100,
                                        'custom_number_15': 100,
                                        'custom_number_16': 100,
                                        'custom_number_17': 100,
                                        'custom_number_18': 100,
                                        'custom_number_19': 100,
                                        'custom_number_2': 100,
                                        'custom_number_3': 100,
                                        'custom_number_4': 100,
                                        'custom_number_5': 100,
                                        'custom_number_6': 100,
                                        'custom_number_7': 100,
                                        'custom_number_8': 100,
                                        'custom_number_9': 100,
                                        'distance_from_base_of_zone': 100,
                                        'distance_from_top_of_zone': 100,
                                        'elevation': 5483.2,
                                        'first_12_boe': 65.15,
                                        'first_12_boe_per_perforated_interval': 13.96,
                                        'first_12_gas': 97.03,
                                        'first_12_gas_per_perforated_interval': 21.07,
                                        'first_12_gor': 1739.13,
                                        'first_12_mmcfge': 390.89,
                                        'first_12_mmcfge_per_perforated_interval': 83.73,
                                        'first_12_oil': 48.98,
                                        'first_12_oil_per_perforated_interval': 10.44,
                                        'first_12_water': 39.29,
                                        'first_12_water_per_perforated_interval': 8.63,
                                        'first_6_boe': 35.53,
                                        'first_6_boe_per_perforated_interval': 7.74,
                                        'first_6_gas': 47.79,
                                        'first_6_gas_per_perforated_interval': 10.68,
                                        'first_6_gor': 1520.05,
                                        'first_6_mmcfge': 213.17,
                                        'first_6_mmcfge_per_perforated_interval': 46.44,
                                        'first_6_oil': 27.56,
                                        'first_6_oil_per_perforated_interval': 5.96,
                                        'first_6_water': 22.83,
                                        'first_6_water_per_perforated_interval': 5.06,
                                        'first_additive_volume': 100,
                                        'first_cluster_count': 100,
                                        'first_discount_cash_flow': 1944.38,
                                        'first_fluid_per_perforated_interval': 100,
                                        'first_fluid_volume': 100,
                                        'first_max_injection_pressure': 100,
                                        'first_max_injection_rate': 100,
                                        'first_prop_weight': 100,
                                        'first_proppant_per_fluid': 100,
                                        'first_proppant_per_perforated_interval': 100,
                                        'first_stage_count': 100,
                                        'first_test_flow_tbg_press': 100,
                                        'first_test_gas_vol': 100,
                                        'first_test_gor': 100,
                                        'first_test_oil_vol': 100,
                                        'first_test_water_vol': 100,
                                        'footage_in_landing_zone': 100,
                                        'formation_thickness_mean': 100,
                                        'gas_breakeven': 100,
                                        'gas_shrunk_eur': 100,
                                        'gas_shrunk_eur_over_pll': 100,
                                        'gas_specific_gravity': 100,
                                        'ground_elevation': 5461.81,
                                        'heelLatitude': 100,
                                        'heelLongitude': 100,
                                        'hz_well_spacing_any_zone': 100,
                                        'hz_well_spacing_same_zone': 100,
                                        'initial_respress': 100,
                                        'initial_restemp': 100,
                                        'irr': 580.55,
                                        'landing_zone_base': 100,
                                        'landing_zone_top': 100,
                                        'last_12_boe': 12.44,
                                        'last_12_boe_per_perforated_interval': 2.53,
                                        'last_12_gas': 34.17,
                                        'last_12_gas_per_perforated_interval': 6.9,
                                        'last_12_gor': 4855.07,
                                        'last_12_mmcfge': 74.61,
                                        'last_12_mmcfge_per_perforated_interval': 15.17,
                                        'last_12_oil': 6.74,
                                        'last_12_oil_per_perforated_interval': 1.38,
                                        'last_12_water': 5.82,
                                        'last_12_water_per_perforated_interval': 1.27,
                                        'last_month_boe': 0.98,
                                        'last_month_boe_per_perforated_interval': 0.2,
                                        'last_month_gas': 2.7,
                                        'last_month_gas_per_perforated_interval': 0.54,
                                        'last_month_gor': 4979.31,
                                        'last_month_mmcfge': 5.88,
                                        'last_month_mmcfge_per_perforated_interval': 1.2,
                                        'last_month_oil': 0.53,
                                        'last_month_oil_per_perforated_interval': 0.11,
                                        'last_month_water': 0.49,
                                        'last_month_water_per_perforated_interval': 0.11,
                                        'lateral_length': 4682,
                                        'lower_perforation': 12882.4,
                                        'matrix_permeability': 100,
                                        'measured_depth': 12925.2,
                                        'month_produced': 62.6,
                                        'ngl_shrunk_eur': 100,
                                        'ngl_shrunk_eur_over_pll': 100,
                                        'nri_oil': 100,
                                        'num_treatment_records': 0.4,
                                        'oil_api_gravity': 100,
                                        'oil_breakeven': 100,
                                        'oil_shrunk_eur': 100,
                                        'oil_shrunk_eur_over_pll': 100,
                                        'oil_specific_gravity': 40.44,
                                        'payout_duration': 18.4,
                                        'perf_lateral_length': 4580.4,
                                        'refrac_additive_volume': 100,
                                        'refrac_cluster_count': 100,
                                        'refrac_fluid_per_perforated_interval': 100,
                                        'refrac_fluid_volume': 100,
                                        'refrac_max_injection_pressure': 100,
                                        'refrac_max_injection_rate': 100,
                                        'refrac_prop_weight': 100,
                                        'refrac_proppant_per_fluid': 100,
                                        'refrac_proppant_per_perforated_interval': 100,
                                        'refrac_stage_count': 100,
                                        'stage_spacing': 100,
                                        'surfaceLatitude': 40.92,
                                        'surfaceLongitude': -104.61,
                                        'thickness': 100,
                                        'toeLatitude': 40.92,
                                        'toeLongitude': -104.62,
                                        'total_additive_volume': 100,
                                        'total_cluster_count': 100,
                                        'total_fluid_per_perforated_interval': 100,
                                        'total_fluid_volume': 0,
                                        'total_prop_weight': 0,
                                        'total_proppant_per_fluid': 100,
                                        'total_proppant_per_perforated_interval': 100,
                                        'total_stage_count': 100,
                                        'true_vertical_depth': 7970.4,
                                        'tubing_depth': 100,
                                        'tubing_id': 100,
                                        'undiscounted_roi': 100,
                                        'upper_perforation': 8302,
                                        'vt_well_spacing_any_zone': 100,
                                        'vt_well_spacing_same_zone': 100,
                                        'wi_oil': 100,
                                        'first_prop_weight/perf_lateral_length': 0.021832154396995897,
                                        'first_fluid_volume/perf_lateral_length': 0.021832154396995897,
                                        'first_prop_weight/perf_lateral_length/hz_well_spacing_same_zone':
                                        0.00021832154396995897,
                                        'first_fluid_volume/perf_lateral_length/hz_well_spacing_same_zone':
                                        0.00021832154396995897,
                                        'first_prop_weight/acre_spacing': 1,
                                        'first_fluid_volume/acre_spacing': 1,
                                        'eur': 102802.0870049473
                                    },
                                    normalizationMin=0.0,
                                    normalizationMax=0.0,
                                    aValue=147.39255237339438,
                                    bValue=-219877.55389907834),
                      qPeak=StepsItem(key='normalize',
                                      base=BaseDocument(key='peak_pll',
                                                        x=OpChainDocument(startFeature='perf_lateral_length',
                                                                          opChain=[]),
                                                        y=OpChainDocument(startFeature='peak_rate', opChain=[])),
                                      name='Normalize',
                                      type='linear',
                                      rangeStart=0.02,
                                      rangeEnd=0.98,
                                      diverged=False,
                                      multiplier=1.0,
                                      target={
                                          'acre_spacing': 100,
                                          'azimuth': 100,
                                          'before_income_tax_cash_flow': 14547.78,
                                          'casing_id': 100,
                                          'choke_size': 100,
                                          'cum_boe': 140.55,
                                          'cum_boe_per_perforated_interval': 30.2,
                                          'cum_gas': 281.4,
                                          'cum_gas_per_perforated_interval': 61.42,
                                          'cum_gor': 2577.96,
                                          'cum_mmcfge': 843.32,
                                          'cum_mmcfge_per_perforated_interval': 181.18,
                                          'cum_oil': 93.65,
                                          'cum_oil_per_perforated_interval': 19.96,
                                          'cum_water': 84.4,
                                          'cum_water_per_perforated_interval': 18.47,
                                          'custom_number_0': 100,
                                          'custom_number_1': 100,
                                          'custom_number_10': 100,
                                          'custom_number_11': 100,
                                          'custom_number_12': 100,
                                          'custom_number_13': 100,
                                          'custom_number_14': 100,
                                          'custom_number_15': 100,
                                          'custom_number_16': 100,
                                          'custom_number_17': 100,
                                          'custom_number_18': 100,
                                          'custom_number_19': 100,
                                          'custom_number_2': 100,
                                          'custom_number_3': 100,
                                          'custom_number_4': 100,
                                          'custom_number_5': 100,
                                          'custom_number_6': 100,
                                          'custom_number_7': 100,
                                          'custom_number_8': 100,
                                          'custom_number_9': 100,
                                          'distance_from_base_of_zone': 100,
                                          'distance_from_top_of_zone': 100,
                                          'elevation': 5483.2,
                                          'first_12_boe': 65.15,
                                          'first_12_boe_per_perforated_interval': 13.96,
                                          'first_12_gas': 97.03,
                                          'first_12_gas_per_perforated_interval': 21.07,
                                          'first_12_gor': 1739.13,
                                          'first_12_mmcfge': 390.89,
                                          'first_12_mmcfge_per_perforated_interval': 83.73,
                                          'first_12_oil': 48.98,
                                          'first_12_oil_per_perforated_interval': 10.44,
                                          'first_12_water': 39.29,
                                          'first_12_water_per_perforated_interval': 8.63,
                                          'first_6_boe': 35.53,
                                          'first_6_boe_per_perforated_interval': 7.74,
                                          'first_6_gas': 47.79,
                                          'first_6_gas_per_perforated_interval': 10.68,
                                          'first_6_gor': 1520.05,
                                          'first_6_mmcfge': 213.17,
                                          'first_6_mmcfge_per_perforated_interval': 46.44,
                                          'first_6_oil': 27.56,
                                          'first_6_oil_per_perforated_interval': 5.96,
                                          'first_6_water': 22.83,
                                          'first_6_water_per_perforated_interval': 5.06,
                                          'first_additive_volume': 100,
                                          'first_cluster_count': 100,
                                          'first_discount_cash_flow': 1944.38,
                                          'first_fluid_per_perforated_interval': 100,
                                          'first_fluid_volume': 100,
                                          'first_max_injection_pressure': 100,
                                          'first_max_injection_rate': 100,
                                          'first_prop_weight': 100,
                                          'first_proppant_per_fluid': 100,
                                          'first_proppant_per_perforated_interval': 100,
                                          'first_stage_count': 100,
                                          'first_test_flow_tbg_press': 100,
                                          'first_test_gas_vol': 100,
                                          'first_test_gor': 100,
                                          'first_test_oil_vol': 100,
                                          'first_test_water_vol': 100,
                                          'footage_in_landing_zone': 100,
                                          'formation_thickness_mean': 100,
                                          'gas_breakeven': 100,
                                          'gas_shrunk_eur': 100,
                                          'gas_shrunk_eur_over_pll': 100,
                                          'gas_specific_gravity': 100,
                                          'ground_elevation': 5461.81,
                                          'heelLatitude': 100,
                                          'heelLongitude': 100,
                                          'hz_well_spacing_any_zone': 100,
                                          'hz_well_spacing_same_zone': 100,
                                          'initial_respress': 100,
                                          'initial_restemp': 100,
                                          'irr': 580.55,
                                          'landing_zone_base': 100,
                                          'landing_zone_top': 100,
                                          'last_12_boe': 12.44,
                                          'last_12_boe_per_perforated_interval': 2.53,
                                          'last_12_gas': 34.17,
                                          'last_12_gas_per_perforated_interval': 6.9,
                                          'last_12_gor': 4855.07,
                                          'last_12_mmcfge': 74.61,
                                          'last_12_mmcfge_per_perforated_interval': 15.17,
                                          'last_12_oil': 6.74,
                                          'last_12_oil_per_perforated_interval': 1.38,
                                          'last_12_water': 5.82,
                                          'last_12_water_per_perforated_interval': 1.27,
                                          'last_month_boe': 0.98,
                                          'last_month_boe_per_perforated_interval': 0.2,
                                          'last_month_gas': 2.7,
                                          'last_month_gas_per_perforated_interval': 0.54,
                                          'last_month_gor': 4979.31,
                                          'last_month_mmcfge': 5.88,
                                          'last_month_mmcfge_per_perforated_interval': 1.2,
                                          'last_month_oil': 0.53,
                                          'last_month_oil_per_perforated_interval': 0.11,
                                          'last_month_water': 0.49,
                                          'last_month_water_per_perforated_interval': 0.11,
                                          'lateral_length': 4682,
                                          'lower_perforation': 12882.4,
                                          'matrix_permeability': 100,
                                          'measured_depth': 12925.2,
                                          'month_produced': 62.6,
                                          'ngl_shrunk_eur': 100,
                                          'ngl_shrunk_eur_over_pll': 100,
                                          'nri_oil': 100,
                                          'num_treatment_records': 0.4,
                                          'oil_api_gravity': 100,
                                          'oil_breakeven': 100,
                                          'oil_shrunk_eur': 100,
                                          'oil_shrunk_eur_over_pll': 100,
                                          'oil_specific_gravity': 40.44,
                                          'payout_duration': 18.4,
                                          'perf_lateral_length': 4580.4,
                                          'refrac_additive_volume': 100,
                                          'refrac_cluster_count': 100,
                                          'refrac_fluid_per_perforated_interval': 100,
                                          'refrac_fluid_volume': 100,
                                          'refrac_max_injection_pressure': 100,
                                          'refrac_max_injection_rate': 100,
                                          'refrac_prop_weight': 100,
                                          'refrac_proppant_per_fluid': 100,
                                          'refrac_proppant_per_perforated_interval': 100,
                                          'refrac_stage_count': 100,
                                          'stage_spacing': 100,
                                          'surfaceLatitude': 40.92,
                                          'surfaceLongitude': -104.61,
                                          'thickness': 100,
                                          'toeLatitude': 40.92,
                                          'toeLongitude': -104.62,
                                          'total_additive_volume': 100,
                                          'total_cluster_count': 100,
                                          'total_fluid_per_perforated_interval': 100,
                                          'total_fluid_volume': 0,
                                          'total_prop_weight': 0,
                                          'total_proppant_per_fluid': 100,
                                          'total_proppant_per_perforated_interval': 100,
                                          'total_stage_count': 100,
                                          'true_vertical_depth': 7970.4,
                                          'tubing_depth': 100,
                                          'tubing_id': 100,
                                          'undiscounted_roi': 100,
                                          'upper_perforation': 8302,
                                          'vt_well_spacing_any_zone': 100,
                                          'vt_well_spacing_same_zone': 100,
                                          'wi_oil': 100,
                                          'first_prop_weight/perf_lateral_length': 0.021832154396995897,
                                          'first_fluid_volume/perf_lateral_length': 0.021832154396995897,
                                          'first_prop_weight/perf_lateral_length/hz_well_spacing_same_zone':
                                          0.00021832154396995897,
                                          'first_fluid_volume/perf_lateral_length/hz_well_spacing_same_zone':
                                          0.00021832154396995897,
                                          'first_prop_weight/acre_spacing': 1,
                                          'first_fluid_volume/acre_spacing': 1,
                                          'peak_rate': 250
                                      },
                                      normalizationMin=0.0,
                                      normalizationMax=0.0,
                                      aValue=2.0861869844538434,
                                      bValue=-2197.770863592384),
                      normalizationType='eur_and_q_peak'),
        'target_eur':
        102802.0870049473,
        'target_q_peak':
        250,
        'apply_normalization':
        True
    }, [[{
        'start_idx': 44871,
        'q_start': 250,
        'end_idx': 46870,
        'q_end': 2,
        'D': 0.002415364550926614,
        'D_eff': 0.5861335336466773,
        'slope': -1,
        'name': 'exp_dec'
    }]]),
    ({
        'segments': [{
            'start_idx': 1,
            'q_start': 1.2,
            'end_idx': 2000,
            'q_end': 5,
            'k': 0.0019009504752376188,
            'D_eff': -0.5786018009004502,
            'slope': 1,
            'name': 'linear'
        }],
        'delta_index':
        np.array([44870]),
        'multipliers': {
            'eur': np.array([1.]),
            'qPeak': np.array([1.])
        },
        'steps':
        None,
        'target_eur':
        6199.999999999999,
        'target_q_peak':
        5,
        'apply_normalization':
        False
    }, [[{
        'start_idx': 44871,
        'q_start': 1.2,
        'end_idx': 46870,
        'q_end': 5.0,
        'k': 0.0019009504752376188,
        'D_eff': -0.5786018009004502,
        'slope': 1,
        'name': 'linear'
    }]])
]


@pytest.mark.unittest
@pytest.mark.parametrize("test_input,expected", test_segments_inputs_two_factor)
def test_apply_two_factor_norm(test_input, expected):

    ret = _get_segments_list(**test_input)
    for i in range(len(expected)):
        for j in range(len(expected[i])):
            for key in expected[i][j]:
                if type(expected[i][j][key]) == float or type(expected[i][j][key]) == int:
                    assert isclose(expected[i][j][key], ret[0][i][j][key])
                else:
                    assert expected[i][j][key], ret[0][i][j][key]


valid_fpds = pd.DataFrame({'well': {0: ObjectId('5e66941fce8c14e6f1eeef46')}, 'FPD': {0: 41089}})
generate_segments_tests = {
    'forecast_id':
    ObjectId('633f37610f8e060013aa700c'),
    'phase':
    'oil',
    'tc_fit_type':
    'rate',
    'tc_P_dict': {
        'best': {
            'segments': [{
                'start_idx': 1,
                'q_start': 186.74278090136298,
                'end_idx': 100,
                'q_end': 169.84640487327286,
                'b': 0.9,
                'D': 0.0010000269878430348,
                'D_eff': 0.2708,
                'slope': -1,
                'name': 'arps'
            }, {
                'start_idx': 101,
                'q_start': 169.84640487327286,
                'end_idx': 200,
                'q_end': 195.0751709290792,
                'b': -0.9,
                'D': -0.001489811255159912,
                'D_eff': -0.5572,
                'slope': 1,
                'name': 'arps_inc'
            }, {
                'start_idx': 201,
                'q_start': 195.0751709290792,
                'end_idx': 300,
                'q_end': 176.6879135854608,
                'D': 0.0010000000000000002,
                'D_eff': 0.30597687659290307,
                'slope': -1,
                'name': 'exp_dec'
            }, {
                'start_idx': 301,
                'q_start': 176.6879135854608,
                'end_idx': 400,
                'q_end': 195.07517092907918,
                'D': -0.0010000000000000002,
                'D_eff': -0.44087418167106884,
                'slope': 1,
                'name': 'exp_inc'
            }, {
                'start_idx': 401,
                'q_start': 195.08,
                'end_idx': 500,
                'q_end': 195.08,
                'c': 195.08,
                'slope': 0,
                'name': 'flat'
            }, {
                'start_idx': 501,
                'q_start': 195.08,
                'end_idx': 600,
                'q_end': 46.58000000000001,
                'k': -1.5,
                'D_eff': 2.808463194586836,
                'slope': 0,
                'name': 'linear'
            }, {
                'start_idx': 601,
                'q_start': 0,
                'end_idx': 700,
                'q_end': 0,
                'slope': 0,
                'name': 'empty'
            }, {
                'start_idx': 701,
                'q_start': 46.58,
                'end_idx': 2526,
                'q_end': 8,
                'sw_idx': 6789.762319838797,
                'q_sw': 2.491126685204824,
                'b': 0.9,
                'D': 0.0023634756059550664,
                'D_eff': 0.47205634078364445,
                'D_exp': 0.0001694056227736825,
                'D_exp_eff': 0.06,
                'target_D_eff_sw': 0.06,
                'realized_D_eff_sw': 0.06,
                'slope': -1,
                'name': 'arps_modified'
            }]
        },
        'P50': {
            'segments': [{
                'start_idx': 1,
                'q_start': 186.74278090136298,
                'end_idx': 100,
                'q_end': 169.84640487327286,
                'b': 0.9,
                'D': 0.0010000269878430348,
                'D_eff': 0.2708,
                'slope': -1,
                'name': 'arps'
            }, {
                'start_idx': 101,
                'q_start': 169.84640487327286,
                'end_idx': 200,
                'q_end': 195.0751709290792,
                'b': -0.9,
                'D': -0.001489811255159912,
                'D_eff': -0.5572,
                'slope': 1,
                'name': 'arps_inc'
            }]
        },
        'P10': {
            'segments': [{
                'start_idx': 1,
                'q_start': 186.74278090136298,
                'end_idx': 100,
                'q_end': 169.84640487327286,
                'b': 0.9,
                'D': 0.0010000269878430348,
                'D_eff': 0.2708,
                'slope': -1,
                'name': 'arps'
            }, {
                'start_idx': 101,
                'q_start': 169.84640487327286,
                'end_idx': 200,
                'q_end': 195.0751709290792,
                'b': -0.9,
                'D': -0.001489811255159912,
                'D_eff': -0.5572,
                'slope': 1,
                'name': 'arps_inc'
            }]
        },
        'P90': {
            'segments': [{
                'start_idx': 1,
                'q_start': 186.74278090136298,
                'end_idx': 100,
                'q_end': 169.84640487327286,
                'b': 0.9,
                'D': 0.0010000269878430348,
                'D_eff': 0.2708,
                'slope': -1,
                'name': 'arps'
            }, {
                'start_idx': 101,
                'q_start': 169.84640487327286,
                'end_idx': 200,
                'q_end': 195.0751709290792,
                'b': -0.9,
                'D': -0.001489811255159912,
                'D_eff': -0.5572,
                'slope': 1,
                'name': 'arps_inc'
            }]
        }
    },
    'tc_ratio_P_dict':
    None,
    'valid_fpds':
    valid_fpds,
    'invalid_fpds':
    pd.DataFrame({'well': []}),
    'tc_phase_param': {
        'apply_normalization': True,
        'data_freq': 'monthly',
        'forecast_id': '633f37610f8e060013aa700c',
        'fpd_source': 'first_prod_date',
        'lookup_table_id_str': None,
        'phase': 'oil',
        'scheduling_id': None,
        'series': 'best',
        'tc_id': '641240f4229c6b43ac522011',
        'well_ids': ['5e66941fce8c14e6f1eeef46'],
        'phase_risk_factors': {
            'oil': 1,
            'gas': 1,
            'water': 1
        },
        'project_id': '633f36ae96f93f00127c51cc',
        'fixed_date': 44998,
        'notification_id': None,
        'user_id': '5ef0d82065ff5f0012ef6d08',
        'batch_count': 500,
        'risk_factor': 1
    },
    'applied_forecast_parent_type':
    'deterministic',
    'TC_series':
    'best',
    'risk_factor_map': {
        '5e66941fce8c14e6f1eeef46': 1
    },
    'forecasts': {
        '5e66941fce8c14e6f1eeef46': {
            'oil': {
                'base_segs': [{
                    'start_idx': 41089,
                    'q_start': 179.97124392400548,
                    'end_idx': 41188,
                    'q_end': 163.68755254431406,
                    'b': 0.9,
                    'D': 0.0010000269878430348,
                    'D_eff': 0.2708,
                    'slope': -1,
                    'name': 'arps'
                }, {
                    'start_idx': 41189,
                    'q_start': 163.68755254431406,
                    'end_idx': 41288,
                    'q_end': 188.0014906136494,
                    'b': -0.9,
                    'D': -0.001489811255159912,
                    'D_eff': -0.5572,
                    'slope': 1,
                    'name': 'arps_inc'
                }, {
                    'start_idx': 41289,
                    'q_start': 188.0014906136494,
                    'end_idx': 41388,
                    'q_end': 170.2809792208705,
                    'D': 0.0010000000000000002,
                    'D_eff': 0.30597687659290307,
                    'slope': -1,
                    'name': 'exp_dec'
                }, {
                    'start_idx': 41389,
                    'q_start': 170.2809792208705,
                    'end_idx': 41488,
                    'q_end': 188.00149061364937,
                    'D': -0.0010000000000000002,
                    'D_eff': -0.44087418167106884,
                    'slope': 1,
                    'name': 'exp_inc'
                }, {
                    'start_idx': 41489,
                    'q_start': 188.00614457615558,
                    'end_idx': 41588,
                    'q_end': 188.00614457615558,
                    'c': 188.00614457615558,
                    'slope': 0,
                    'name': 'flat'
                }, {
                    'start_idx': 41589,
                    'q_start': 188.00614457615558,
                    'end_idx': 41688,
                    'q_end': 44.890948402487844,
                    'k': -1.4456080421582598,
                    'D_eff': 2.808463194586836,
                    'slope': 0,
                    'name': 'linear'
                }, {
                    'start_idx': 41689,
                    'q_start': 0,
                    'end_idx': 41788,
                    'q_end': 0,
                    'slope': 0,
                    'name': 'empty'
                }, {
                    'start_idx': 41789,
                    'q_start': 44.89094840248783,
                    'end_idx': 43614,
                    'q_end': 7.709909558177386,
                    'sw_idx': 47877.762319838796,
                    'q_sw': 2.4007951801114276,
                    'b': 0.9,
                    'D': 0.0023634756059550664,
                    'D_eff': 0.47205634078364445,
                    'D_exp': 0.0001694056227736825,
                    'D_exp_eff': 0.06,
                    'target_D_eff_sw': 0.06,
                    'realized_D_eff_sw': 0.06,
                    'slope': -1,
                    'name': 'arps_modified'
                }],
                'data_freq':
                'monthly'
            },
            'gas': {
                'base_segs': [],
                'data_freq': 'monthly'
            },
            'water': {
                'base_segs': [],
                'data_freq': 'monthly'
            }
        }
    },
    'cums_and_last_prods': {
        'daily': {},
        'monthly': {
            '5e66941fce8c14e6f1eeef46': {
                'last_prod': 43812,
                'oil': 133236.0,
                'gas': 342757.0,
                'water': 133803.0
            }
        }
    },
    'update_eur':
    True,
    'steps':
    StepsDocument(eur=StepsItem(key='normalize',
                                base=BaseDocument(key='eur_pll',
                                                  x=OpChainDocument(startFeature='perf_lateral_length', opChain=[]),
                                                  y=OpChainDocument(startFeature='eur', opChain=[])),
                                name='Normalize',
                                type='linear',
                                rangeStart=0.02,
                                rangeEnd=0.98,
                                diverged=False,
                                multiplier=1.0,
                                target={
                                    'acre_spacing': 100,
                                    'azimuth': 100,
                                    'before_income_tax_cash_flow': 537.86,
                                    'casing_id': 100,
                                    'choke_size': 16,
                                    'cum_boe': 167.15,
                                    'cum_boe_per_perforated_interval': 22.3,
                                    'cum_gas': 255.25,
                                    'cum_gas_per_perforated_interval': 34.06,
                                    'cum_gor': 2009.42,
                                    'cum_mmcfge': 1002.9,
                                    'cum_mmcfge_per_perforated_interval': 133.8,
                                    'cum_oil': 124.61,
                                    'cum_oil_per_perforated_interval': 16.62,
                                    'cum_water': 71.39,
                                    'cum_water_per_perforated_interval': 9.53,
                                    'custom_number_0': 100,
                                    'custom_number_1': 100,
                                    'custom_number_10': 100,
                                    'custom_number_11': 100,
                                    'custom_number_12': 100,
                                    'custom_number_13': 100,
                                    'custom_number_14': 100,
                                    'custom_number_15': 100,
                                    'custom_number_16': 100,
                                    'custom_number_17': 100,
                                    'custom_number_18': 100,
                                    'custom_number_19': 100,
                                    'custom_number_2': 100,
                                    'custom_number_3': 100,
                                    'custom_number_4': 100,
                                    'custom_number_5': 100,
                                    'custom_number_6': 100,
                                    'custom_number_7': 100,
                                    'custom_number_8': 100,
                                    'custom_number_9': 100,
                                    'distance_from_base_of_zone': 100,
                                    'distance_from_top_of_zone': 100,
                                    'elevation': 518,
                                    'first_12_boe': 84.76,
                                    'first_12_boe_per_perforated_interval': 11.31,
                                    'first_12_gas': 79.44,
                                    'first_12_gas_per_perforated_interval': 10.6,
                                    'first_12_gor': 1112.63,
                                    'first_12_mmcfge': 508.53,
                                    'first_12_mmcfge_per_perforated_interval': 67.84,
                                    'first_12_oil': 71.52,
                                    'first_12_oil_per_perforated_interval': 9.54,
                                    'first_12_water': 28.87,
                                    'first_12_water_per_perforated_interval': 3.85,
                                    'first_6_boe': 63.74,
                                    'first_6_boe_per_perforated_interval': 8.5,
                                    'first_6_gas': 56.39,
                                    'first_6_gas_per_perforated_interval': 7.52,
                                    'first_6_gor': 1060.36,
                                    'first_6_mmcfge': 382.46,
                                    'first_6_mmcfge_per_perforated_interval': 51.02,
                                    'first_6_oil': 54.34,
                                    'first_6_oil_per_perforated_interval': 7.25,
                                    'first_6_water': 21.27,
                                    'first_6_water_per_perforated_interval': 2.84,
                                    'first_additive_volume': 999864,
                                    'first_cluster_count': 100,
                                    'first_discount_cash_flow': 62.88,
                                    'first_fluid_per_perforated_interval': 15.51,
                                    'first_fluid_volume': 116238.62,
                                    'first_max_injection_pressure': 100,
                                    'first_max_injection_rate': 100,
                                    'first_prop_weight': 6994054,
                                    'first_proppant_per_fluid': 1.43,
                                    'first_proppant_per_perforated_interval': 933.2,
                                    'first_stage_count': 26,
                                    'first_test_flow_tbg_press': 1400,
                                    'first_test_gas_vol': 323,
                                    'first_test_gor': 100,
                                    'first_test_oil_vol': 561,
                                    'first_test_water_vol': 595,
                                    'footage_in_landing_zone': 3626.77,
                                    'formation_thickness_mean': 183.58,
                                    'gas_breakeven': 100,
                                    'gas_shrunk_eur': 100,
                                    'gas_shrunk_eur_over_pll': 100,
                                    'gas_specific_gravity': 100,
                                    'ground_elevation': 493,
                                    'heelLatitude': 100,
                                    'heelLongitude': 100,
                                    'hz_well_spacing_any_zone': 4255.98,
                                    'hz_well_spacing_same_zone': 100,
                                    'initial_respress': 100,
                                    'initial_restemp': 100,
                                    'irr': 14.88,
                                    'landing_zone_base': 100,
                                    'landing_zone_top': 100,
                                    'last_12_boe': 5,
                                    'last_12_boe_per_perforated_interval': 0.67,
                                    'last_12_gas': 7.98,
                                    'last_12_gas_per_perforated_interval': 1.07,
                                    'last_12_gor': 2498.95,
                                    'last_12_mmcfge': 30.03,
                                    'last_12_mmcfge_per_perforated_interval': 4.01,
                                    'last_12_oil': 3.67,
                                    'last_12_oil_per_perforated_interval': 0.49,
                                    'last_12_water': 0.64,
                                    'last_12_water_per_perforated_interval': 0.09,
                                    'last_month_boe': 0.36,
                                    'last_month_boe_per_perforated_interval': 0.05,
                                    'last_month_gas': 0.62,
                                    'last_month_gas_per_perforated_interval': 0.08,
                                    'last_month_gor': 2633.15,
                                    'last_month_mmcfge': 2.14,
                                    'last_month_mmcfge_per_perforated_interval': 0.29,
                                    'last_month_oil': 0.25,
                                    'last_month_oil_per_perforated_interval': 0.03,
                                    'last_month_water': 0.05,
                                    'last_month_water_per_perforated_interval': 0.01,
                                    'lateral_length': 100,
                                    'lower_perforation': 15579,
                                    'matrix_permeability': 100,
                                    'measured_depth': 15737,
                                    'month_produced': 79.5,
                                    'ngl_shrunk_eur': 100,
                                    'ngl_shrunk_eur_over_pll': 100,
                                    'nri_oil': 100,
                                    'num_treatment_records': 100,
                                    'oil_api_gravity': 46.75,
                                    'oil_breakeven': 100,
                                    'oil_shrunk_eur': 100,
                                    'oil_shrunk_eur_over_pll': 100,
                                    'oil_specific_gravity': 100,
                                    'payout_duration': 109,
                                    'perf_lateral_length': 7496,
                                    'refrac_additive_volume': 100,
                                    'refrac_cluster_count': 100,
                                    'refrac_fluid_per_perforated_interval': 100,
                                    'refrac_fluid_volume': 100,
                                    'refrac_max_injection_pressure': 100,
                                    'refrac_max_injection_rate': 100,
                                    'refrac_prop_weight': 100,
                                    'refrac_proppant_per_fluid': 100,
                                    'refrac_proppant_per_perforated_interval': 100,
                                    'refrac_stage_count': 100,
                                    'stage_spacing': 100,
                                    'surfaceLatitude': 28.84,
                                    'surfaceLongitude': -98.53,
                                    'thickness': 100,
                                    'toeLatitude': 28.85,
                                    'toeLongitude': -98.53,
                                    'total_additive_volume': 999864,
                                    'total_cluster_count': 100,
                                    'total_fluid_per_perforated_interval': 15.51,
                                    'total_fluid_volume': 116238.62,
                                    'total_prop_weight': 6994054,
                                    'total_proppant_per_fluid': 1.43,
                                    'total_proppant_per_perforated_interval': 933.2,
                                    'total_stage_count': 26,
                                    'true_vertical_depth': 9884.5,
                                    'tubing_depth': 100,
                                    'tubing_id': 100,
                                    'undiscounted_roi': 100,
                                    'upper_perforation': 10277.5,
                                    'vt_well_spacing_any_zone': 2,
                                    'vt_well_spacing_same_zone': 100,
                                    'wi_oil': 100,
                                    'first_prop_weight/perf_lateral_length': 933.0381536819638,
                                    'first_fluid_volume/perf_lateral_length': 15.506752934898612,
                                    'first_prop_weight/perf_lateral_length/hz_well_spacing_same_zone':
                                    9.330381536819637,
                                    'first_fluid_volume/perf_lateral_length/hz_well_spacing_same_zone':
                                    0.15506752934898613,
                                    'first_prop_weight/acre_spacing': 69940.54,
                                    'first_fluid_volume/acre_spacing': 1162.3862,
                                    'eur': 136646.31508394956
                                },
                                normalizationMin=0.0,
                                normalizationMax=0.0,
                                aValue=1238.7434348792233,
                                bValue=-9147429.81411382),
                  qPeak=StepsItem(key='normalize',
                                  base=BaseDocument(key='eur_pll',
                                                    x=OpChainDocument(startFeature='perf_lateral_length', opChain=[]),
                                                    y=OpChainDocument(startFeature='$PHASE_EUR', opChain=[])),
                                  name='Normalize',
                                  type='no_normalization',
                                  rangeStart=0.02,
                                  rangeEnd=0.98,
                                  diverged=False,
                                  multiplier=1.0,
                                  target={},
                                  normalizationMin=None,
                                  normalizationMax=None,
                                  aValue=None,
                                  bValue=None),
                  normalizationType='eur'),
    'apply_normalization':
    True,
    'normalize_warning':
    False
}
invalid_bulk_list = []
manual_segments = {
    'best': [{
        'start_idx': 41089,
        'q_start': 179.97124392400548,
        'end_idx': 41188,
        'q_end': 163.68755254431406,
        'b': 0.9,
        'D': 0.0010000269878430348,
        'D_eff': 0.2708,
        'slope': -1,
        'name': 'arps'
    }, {
        'start_idx': 41189,
        'q_start': 163.68755254431406,
        'end_idx': 41288,
        'q_end': 188.0014906136494,
        'b': -0.9,
        'D': -0.001489811255159912,
        'D_eff': -0.5572,
        'slope': 1,
        'name': 'arps_inc'
    }, {
        'start_idx': 41289,
        'q_start': 188.0014906136494,
        'end_idx': 41388,
        'q_end': 170.2809792208705,
        'D': 0.0010000000000000002,
        'D_eff': 0.30597687659290307,
        'slope': -1,
        'name': 'exp_dec'
    }, {
        'start_idx': 41389,
        'q_start': 170.2809792208705,
        'end_idx': 41488,
        'q_end': 188.00149061364937,
        'D': -0.0010000000000000002,
        'D_eff': -0.44087418167106884,
        'slope': 1,
        'name': 'exp_inc'
    }, {
        'start_idx': 41489,
        'q_start': 188.00614457615558,
        'end_idx': 41588,
        'q_end': 188.00614457615558,
        'c': 188.00614457615558,
        'slope': 0,
        'name': 'flat'
    }, {
        'start_idx': 41589,
        'q_start': 188.00614457615558,
        'end_idx': 41688,
        'q_end': 44.890948402487844,
        'k': -1.4456080421582598,
        'D_eff': 2.808463194586836,
        'slope': 0,
        'name': 'linear'
    }, {
        'start_idx': 41689,
        'q_start': 0,
        'end_idx': 41788,
        'q_end': 0,
        'slope': 0,
        'name': 'empty'
    }, {
        'start_idx': 41789,
        'q_start': 44.89094840248783,
        'end_idx': 43614,
        'q_end': 7.709909558177386,
        'sw_idx': 47877.762319838796,
        'q_sw': 2.4007951801114276,
        'b': 0.9,
        'D': 0.0023634756059550664,
        'D_eff': 0.47205634078364445,
        'D_exp': 0.0001694056227736825,
        'D_exp_eff': 0.06,
        'target_D_eff_sw': 0.06,
        'realized_D_eff_sw': 0.06,
        'slope': -1,
        'name': 'arps_modified'
    }]
}

test_generate_apply_tc_segments = [(generate_segments_tests, [invalid_bulk_list, manual_segments])]


@pytest.mark.unittest
@pytest.mark.parametrize("test_input,expected", test_generate_apply_tc_segments)
def test_generate_apply_tc_segments(test_input, expected):
    context = MockContext()
    tc_apply_service = TypeCurveApplyService(context)
    _, invalid_bulk_list, _, manual_segments = tc_apply_service._generate_bulk_lists(**test_input)
    assert invalid_bulk_list == expected[0]

    for seg_type in manual_segments:
        for i, this_segment in enumerate(manual_segments[seg_type]):
            for key in this_segment:
                if type(this_segment[key]) == float or type(this_segment[key]) == int:
                    assert isclose(this_segment[key], expected[1][seg_type][i][key])
                else:
                    assert this_segment[key], expected[1][seg_type][i][key]
